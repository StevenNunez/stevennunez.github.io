<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1'/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hostile Developer - Working with Templates in Ruby ERB</title>
  <link href="/favicon.ico" rel="icon" type="image/ico" />
  <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
</head>
<body>
<div id="container">
  <section id="header">
  <header>
<a href="/">        <h1 class="brand"><span class="hostile">Hostile</span> Developer</h1>
        <h4 class="tag-line">I am Steven. Hear me Rant.</h4>
</a>  </header>

  <section class='social'>
    <a href="http://twitter.com/_StevenNunez/" target="_blank"><i class="fa fa-twitter"></i></a>
    <a href="https://github.com/StevenNunez/" target="_blank"><i class="fa fa-github"></i></a>
  </section>
</section>


  <main id='article' role="main">
    <h1 class="article-title"><a href="/2015/05/28/working-with-templates-in-ruby-erb.html">Working with Templates in Ruby ERB</a></h1>
    <h1>Templates in ERB</h1>

<p>This post is a bit of a thought experiment. Looking into this led me down the route of some interesting ruby solutions.</p>

<h2>The problem</h2>

<p>Ruby ships with the <code>erb</code> library, but it natively doesn&rsquo;t come with a way to wrap one ERB file in another. This makes composing files difficult. There&rsquo;s no way to use something like rails&rsquo; <code>yield</code> method.</p>

<h3>Some Basic ERB</h3>

<p>Here&rsquo;s how we&rsquo;d render a simple erb template.</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">require</span> <span class="s1">'erb'</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">"1 and 1 is &lt;%= 1 + 1 %&gt;"</span>
<span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">).</span><span class="nf">result</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>This returns the interpreted string. If we try to use the <code>yield</code> keyword, we&rsquo;ll run into a bit of a problem.</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">require</span> <span class="s1">'erb'</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">"&lt;%= yield %&gt;"</span>
<span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">).</span><span class="nf">result</span> <span class="c1">#=&gt; LocalJumpError: no block given (yield)</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Eek! No bueno. You might be thinking, &ldquo;Well, you have to give a block to&hellip; something&rdquo;. Good guess, but wrong.</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nb">require</span> <span class="s1">'erb'</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">"&lt;%= yield %&gt;"</span>
<span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">).</span><span class="nf">result</span> <span class="k">do</span>
  <span class="s2">"HERE"</span>
<span class="k">end</span>
<span class="c1"># or</span>
<span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">)</span> <span class="k">do</span>
  <span class="s2">"HERE"</span>
<span class="k">end</span><span class="p">.</span><span class="nf">result</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>All sorts of crazy happens.</p>

<h3>Defining a Renderer</h3>

<p>ERB does come with a curious set of methods that let you add the current context of the ERB instance (stuff like the template, variables, all that stuff), to another object.</p>

<p>That looks like this:</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="nb">require</span> <span class="s1">'erb'</span>
<span class="c1"># create a container for our new method</span>
<span class="k">class</span> <span class="nc">LayoutRenderer</span>
<span class="k">end</span>

<span class="c1"># load the erb instance</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">"Before &lt;%= yield %&gt; After"</span>
<span class="n">erb</span> <span class="o">=</span> <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

<span class="c1"># create method on LayoutRenderer. We'll pass a block to THIS method</span>
<span class="n">erb</span><span class="p">.</span><span class="nf">def_method</span><span class="p">(</span><span class="no">LayoutRenderer</span><span class="p">,</span> <span class="s1">'render'</span><span class="p">)</span>

<span class="c1"># Then call our LayoutRenderer</span>
<span class="n">result</span> <span class="o">=</span> <span class="no">LayoutRenderer</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">render</span> <span class="k">do</span>
  <span class="s2">"I'm somewhere in the middle"</span>
<span class="k">end</span>
<span class="n">result</span> <span class="c1"># =&gt; "Before I'm somewhere in the middle After"</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Cool! Now it&rsquo;s a matter of rendering another template inside of it. We&rsquo;ll need a few files:</p>

<p>A layout:</p>
<div class="highlight"><pre class="highlight html"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>  <span class="cp">&lt;!DOCTYPE html&gt;</span>
  <span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Document<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Layout<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">yield</span> <span class="err">%</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
  <span class="nt">&lt;/html&gt;</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>An index file:</p>
<div class="highlight"><pre class="highlight html"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;p&gt;</span>
  I'm in a template
<span class="nt">&lt;/p&gt;</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>And our renderer code:</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="nb">require</span> <span class="s1">'erb'</span>

<span class="k">class</span> <span class="nc">LayoutRenderer</span>
<span class="k">end</span>

<span class="n">layout_template</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'layout.html.erb'</span><span class="p">)</span>
<span class="n">inner_template</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'index.html.erb'</span><span class="p">)</span>

<span class="n">layout</span> <span class="o">=</span> <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">layout_template</span><span class="p">)</span>
<span class="n">inner</span> <span class="o">=</span> <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">inner_template</span><span class="p">)</span>

<span class="n">layout</span><span class="p">.</span><span class="nf">def_method</span><span class="p">(</span><span class="no">LayoutRenderer</span><span class="p">,</span> <span class="s1">'render'</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="no">LayoutRenderer</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">render</span> <span class="k">do</span>
  <span class="n">inner</span><span class="p">.</span><span class="nf">result</span> <span class="c1"># call the regular erb #result method</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="n">result</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>NOTE: If you&rsquo;re playing with this and try to <code>puts</code> this line&hellip;</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">puts</span> <span class="no">LayoutRenderer</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">render</span> <span class="k">do</span>
  <span class="n">inner</span><span class="p">.</span><span class="nf">result</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>&hellip; you&rsquo;ll get some weird issue. I think it&rsquo;s trying to finish the render before loading the block.</p>

<h2>Final Thoughts</h2>

<p>This was fun to play with. Until next time, Happy Clacking.</p>

    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'hostiledeveloper'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  </main>

 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48123503-1', 'auto');
  ga('send', 'pageview');

</script>

 <em>Copyright &copy; 2018 Steven Nu&ntilde;ez - HostileDeveloper</em>

</div>
</body>
</html>
