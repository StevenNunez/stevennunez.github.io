<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1'/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hostile Developer - Let's build something with Rack</title>
  <link href="/favicon.ico" rel="icon" type="image/ico" />
  <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    document.addEventListener("DOMContentLoaded", function(event) {
      mermaid.initialize({startOnLoad:true});
    });
  </script>
<div id="container">
  <section id="header">
  <header>
<a href="/">        <h1 class="brand"><span class="hostile">Hostile</span> Developer</h1>
        <h4 class="tag-line">I am Steven. Hear me Rant.</h4>
</a>  </header>

  <section class='social'>
    <a href="http://twitter.com/_StevenNunez/" target="_blank"><i class="fa fa-twitter"></i></a>
    <a href="https://github.com/StevenNunez/" target="_blank"><i class="fa fa-github"></i></a>
  </section>
</section>


  <main id='article' role="main">
    <h1 class="article-title"><a href="/2015/08/23/let-s-build-something-with-rack.html">Let's build something with Rack</a></h1>
    <h1>Slow down!</h1>

<p>When it&rsquo;s time to build a web app, we go for the big guns. <code>gem &#39;rails&#39;</code> in the <code>Gemfile</code> and we&rsquo;re off to races. What if we didn&rsquo;t? What if we tried to carefully craft every line in our app? What if we only added <a href="https://github.com/sstephenson/sprockets">Sprockets</a> when we needed it? What if we want granular control of our <a href="https://github.com/hassox/warden">app&rsquo;s security</a>? Or what if we just want a better idea of what&rsquo;s actually happening when a user visits our site?</p>

<h2>Rack - The Bow Drill of Web Apps</h2>

<p>Let&rsquo;s build a simple web app using just rack and rack middleware. Along the way we&rsquo;ll learn about some rack features like URLMap and writing custom middleware.</p>

<h2>The App - Programmer of the Day</h2>

<p>What are we without our past? Let&rsquo;s write an app where we can keep track of our programming heroes. The app, PotD is our one stop for learning about awesome coders.</p>

<h3>Planning</h3>

<p>We&rsquo;ll need a few routes:</p>

<ul>
<li>GET / gives you a link to the &ldquo;All Programmers&rdquo; page</li>
<li>GET /programmers returns a list of our programmers</li>
<li>GET /programmers/4 returns a programmer with an id of 4</li>
</ul>

<p>We&rsquo;ll also add Bootstrap since all websites need Bootstrap.</p>

<h3>Starter App</h3>

<p>I&rsquo;ve set up a database and basic setup <a href="https://github.com/octosteve/rack_no_rails">here</a>. Other than <code>rack</code> being in the <code>Gemfile</code> there&rsquo;s nothing webby about this!</p>

<h2>Rackup!</h2>

<p>In our <code>config.ru</code> file we&rsquo;ll start off by handling the <code>GET /</code> requirement.</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">App</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">get?</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="p">.</span><span class="nf">path</span> <span class="o">==</span> <span class="s2">"/"</span>
      <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"You're at the home page!"</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"File not found"</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">ContentType</span>
<span class="n">run</span> <span class="no">App</span><span class="p">.</span><span class="nf">new</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>If this looks crazy, take a look at the my <a href="/2015/08/21/lets-learn-about-rack.html">Rack Basics</a> post.</p>

<p>Running <code>rackup</code> starts the app. Let&rsquo;s make the homepage load a template.</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">App</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">get?</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="p">.</span><span class="nf">path</span> <span class="o">==</span> <span class="s2">"/"</span>
      <span class="n">template</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'app/views/home/index.html.erb'</span><span class="p">)</span>
      <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"File not found"</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">ContentType</span>
<span class="n">run</span> <span class="no">App</span><span class="p">.</span><span class="nf">new</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Put this template in app/views/home/index.html.erb. We&rsquo;re not actually using erb for this template, but let&rsquo;s keep the template names consistent.</p>
<div class="highlight"><pre class="highlight html"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>Potd<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Welcome to Programmer of the Day!<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/programmers"</span><span class="nt">&gt;</span>Click here<span class="nt">&lt;/a&gt;</span> to get a list of our programmers.
    <span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/about"</span><span class="nt">&gt;</span>Click here<span class="nt">&lt;/a&gt;</span> to learn more about the app.
    <span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>If you&rsquo;re thinking about <code>yield</code> and templates and all that&hellip; go read <a href="/2015/05/28/working-with-templates-in-ruby-erb.html">this</a>. I&rsquo;m not touching it in the post.</p>

<p>Cool! One story DONE! But this code looks crazy already. Let&rsquo;s break some of this code into controllers.</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1"># HomeController in app/controllers</span>
<span class="k">class</span> <span class="nc">HomeController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">template</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'app/views/home/index.html.erb'</span><span class="p">)</span>
    <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>In <code>config.ru</code> we bring in our <code>environment</code> file so it loads all our classes.</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c1"># config.ru</span>
<span class="nb">require_relative</span> <span class="s1">'config/environment'</span>
<span class="k">class</span> <span class="nc">App</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">get?</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="p">.</span><span class="nf">path</span> <span class="o">==</span> <span class="s2">"/"</span>
      <span class="no">HomeController</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">index</span>
    <span class="k">else</span>
      <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"File not found"</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">ContentType</span>
<span class="n">run</span> <span class="no">App</span><span class="p">.</span><span class="nf">new</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Better&hellip; but we can do better by using rack&rsquo;s <code>URLMap</code> functionality. We can essentially break up parts of our app into parallel rack apps that only get called if a route matches. The cool thing is that we can set the middleware to run all ALL routes by setting it outside the block, or create our custom stack  for each route.</p>

<p>Here&rsquo;s the updated <code>config.ru</code> and HomeController</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="c1"># config.ru</span>
<span class="nb">require_relative</span> <span class="s1">'config/environment'</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">ContentType</span>
<span class="n">map</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">run</span> <span class="no">HomeController</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>

<span class="c1"># HomeController</span>
<span class="k">class</span> <span class="nc">HomeController</span>
  <span class="nb">attr_reader</span> <span class="ss">:request</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="vi">@request</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">get?</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="p">.</span><span class="nf">path</span> <span class="o">==</span> <span class="s1">'/'</span>
      <span class="n">index</span>
    <span class="k">else</span>
      <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"File not found"</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">template</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'app/views/home/index.html.erb'</span><span class="p">)</span>
    <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>This is MUCH better. We had to give the controller it&rsquo;s own <code>#call</code> method since it gets called only when this route matches. There is a bit of a smell, and we have a hunch we&rsquo;re heading to the duplication dunes, but we soldier on.</p>

<h2>All the programmers!</h2>

<p>Let&rsquo;s make a new controller for our programmers route.</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="c1"># ProgrammersController</span>
<span class="k">class</span> <span class="nc">ProgrammersController</span>
  <span class="nb">attr_reader</span> <span class="ss">:request</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="vi">@request</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">get?</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="p">.</span><span class="nf">path</span> <span class="o">==</span> <span class="s1">'/programmers'</span>
      <span class="n">index</span>
    <span class="k">else</span>
      <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"File not found"</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">programmers</span> <span class="o">=</span> <span class="no">Programmer</span><span class="p">.</span><span class="nf">all</span>
    <span class="n">template</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'app/views/programmers/index.html.erb'</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">).</span><span class="nf">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
    <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>And the template</p>
<div class="highlight"><pre class="highlight html"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>Potd<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Checkout our programmers!<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;</span><span class="err">%</span> <span class="na">programmers</span><span class="err">.</span><span class="na">each</span> <span class="na">do</span> <span class="err">|</span><span class="na">programmer</span><span class="err">|</span> <span class="err">%</span><span class="nt">&gt;</span>
      <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/programmers/&lt;%= programmer.id %&gt;"</span><span class="nt">&gt;&lt;</span><span class="err">%=</span> <span class="na">programmer</span><span class="err">.</span><span class="na">name</span> <span class="err">%</span><span class="nt">&gt;&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;</span><span class="err">%</span> <span class="na">end</span> <span class="err">%</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</pre></td></tr></tbody></table></code></pre></div>
<p>Here we have the call method, again, acting as our router, delegating out to our index action or 404ing when it doesn&rsquo;t find anything. Again&hellip; this smells, we see some duplication, but we&rsquo;ll hold off. In the immortal words of <a href="http://bobnadler.com/">Bobby &ldquo;Crouton&rdquo; Nadler</a>, wait for duplication at least 3 times. By then, you should understand exactly what&rsquo;s being repeated.</p>

<p>Our <code>config.ru</code> looks like this now:</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nb">require_relative</span> <span class="s1">'config/environment'</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">ContentType</span>

<span class="n">map</span> <span class="s1">'/programmers'</span> <span class="k">do</span>
  <span class="n">run</span> <span class="no">ProgrammersController</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>
<span class="n">map</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">run</span> <span class="no">HomeController</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<h3>Dynamic Segments - Wrath of the Regex</h3>

<p>Ok, so our next requirement is going to make us get&hellip; creative. We&rsquo;re going to have to write a router, and write some interesting regular expressions. Let&rsquo;s get started.</p>

<p>The code I wish worked looks something like this</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1"># config/routes.rb</span>
<span class="no">Routes</span> <span class="o">=</span> <span class="no">Router</span><span class="p">.</span><span class="nf">new</span>
<span class="no">Routes</span><span class="p">.</span><span class="nf">add_route</span><span class="p">(</span><span class="ss">method: </span><span class="s2">"GET"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"/programmers"</span><span class="p">,</span> <span class="ss">handler: </span><span class="s2">"ProgrammersController#index"</span><span class="p">)</span>
<span class="no">Routes</span><span class="p">.</span><span class="nf">add_route</span><span class="p">(</span><span class="ss">method: </span><span class="s2">"GET"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"/programmers/:id"</span><span class="p">,</span> <span class="ss">handler: </span><span class="s2">"ProgrammersController#show"</span><span class="p">)</span>
<span class="no">Routes</span><span class="p">.</span><span class="nf">add_route</span><span class="p">(</span><span class="ss">method: </span><span class="s2">"GET"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"/"</span><span class="p">,</span> <span class="ss">handler: </span><span class="s2">"HomeController#index"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>It would handle any dynamic segment extraction, and call the right controller, modifying params along the way.</p>

<p>This changes our current strategy of using URLMap since the mapping will be made by the router, and not by individual blocks.</p>

<h3>WARNING: LOTS OF CODE</h3>

<p>Ok&hellip; so don&rsquo;t run. We&rsquo;re friends right? You trust me right? We&rsquo;ll get through this. Just&hellip; don&rsquo;t&hellip; run&hellip;</p>

<p>We&rsquo;ll start with the new <code>config.ru</code> file:</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nb">require_relative</span> <span class="s1">'config/environment'</span>
<span class="nb">require_relative</span> <span class="s1">'config/routes'</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">ContentType</span>
<span class="n">run</span> <span class="no">Routes</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Nice right? It loads all of our routes. <code>Routes</code> was made a constant so we could load it in another file and it stay in memory. Basically it&rsquo;s a global. Sue me.</p>

<p>We needed to make a <code>Router</code> class to get support this awesome syntax</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="c1"># lib/router.rb</span>
<span class="k">class</span> <span class="nc">Router</span>
  <span class="nb">attr_reader</span> <span class="ss">:request</span><span class="p">,</span> <span class="ss">:routes</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@routes</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="vi">@request</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">route</span> <span class="o">=</span> <span class="n">routes</span><span class="p">[[</span><span class="n">request</span><span class="p">.</span><span class="nf">request_method</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="nf">path</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">route</span>
      <span class="n">call_action_for</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"File not found"</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">add_route</span><span class="p">(</span><span class="nb">method</span><span class="p">:,</span> <span class="n">path</span><span class="p">:,</span> <span class="n">handler</span><span class="p">:)</span>
    <span class="n">routes</span><span class="p">[[</span><span class="nb">method</span><span class="p">,</span> <span class="n">path</span><span class="p">]]</span> <span class="o">=</span> <span class="n">handler</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="k">def</span> <span class="nf">call_action_for</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
    <span class="n">controller</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">route</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"#"</span><span class="p">)</span>
    <span class="n">controller_class</span> <span class="o">=</span> <span class="no">Kernel</span><span class="p">.</span><span class="nf">const_get</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
    <span class="n">controller_class</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">public_send</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>DON&rsquo;T RUN! Let me explain. You have to think of the router as having 2 big roles. Storing URL, Method combinations, and looking up what to do if it finds a match.</p>

<p>The methods related to that first job are <code>#initialize</code> and <code>#add_route</code>. Here, we&rsquo;re just giving it the rules. The sexiness is in the <code>#call</code> method. Rack will call this method when a request comes in and we&rsquo;ll find a route.</p>

<p>In <code>#add_route</code> we&rsquo;re making the key of the hash&hellip; an array. You&rsquo;re seeing that right. The value is the string version of the controller#action.</p>

<p><code>#call</code> method asks for the route. Not found? 404, Found? MAGIC.</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">call_action_for</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
  <span class="n">controller</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">route</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"#"</span><span class="p">)</span>
  <span class="n">controller_class</span> <span class="o">=</span> <span class="no">Kernel</span><span class="p">.</span><span class="nf">const_get</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
  <span class="n">controller_class</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">public_send</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Split the string, Find a controller with that name, instantiate and call the action.</p>

<h3>Bad news</h3>

<p>This doesn&rsquo;t work for the <code>/programmers/1</code> path. All that work&hellip; for NOTHING! Let&rsquo;s make Sandi Metz proud and MAKE MOAR OBJECTS! We&rsquo;ll need our &ldquo;Route&rdquo; to be smarter than just an array.</p>

<h3>Route object</h3>

<p>We need to write our own equality so that we can compare <code>/programmers/:id</code> and have it equal <code>/programmers/1</code>. We also want to make it so that <code>/programmers</code> equals <code>/programmers</code> (no dynamic segments here).</p>

<p>Here&rsquo;s our first pass at it</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Route</span>
  <span class="nb">attr_reader</span> <span class="ss">:method</span><span class="p">,</span> <span class="ss">:path</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">method</span><span class="p">:,</span> <span class="n">path</span><span class="p">:)</span>
    <span class="vi">@method</span> <span class="o">=</span> <span class="nb">method</span>
    <span class="vi">@path</span> <span class="o">=</span> <span class="n">path</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">===</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
     <span class="n">match_path</span> <span class="o">===</span> <span class="n">other</span><span class="p">.</span><span class="nf">path</span> <span class="o">&amp;&amp;</span> <span class="nb">method</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="nf">method</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">match_path</span>
    <span class="k">return</span> <span class="n">path</span> <span class="k">unless</span> <span class="n">has_dynamic_segment?</span>
    <span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/:\w+/</span><span class="p">,</span> <span class="s1">'(\w+)'</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"$"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">has_dynamic_segment?</span>
    <span class="n">path</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">":"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>We write a regular expression that replaces any part of the string that starts with a <code>:</code> with a <code>\w+</code>. Meaning replace <code>/programmers/:id</code> into A regular expression containing <code>/programmers/(\w+)</code>.</p>

<p>We updated our Router too:</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Router</span>
  <span class="nb">attr_reader</span> <span class="ss">:request</span><span class="p">,</span> <span class="ss">:routes</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@routes</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="vi">@request</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">current_route</span> <span class="o">=</span> <span class="no">Route</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">path</span><span class="ss">:request</span><span class="p">.</span><span class="nf">path</span><span class="p">,</span> <span class="nb">method</span><span class="ss">:request</span><span class="p">.</span><span class="nf">request_method</span><span class="p">)</span>
    <span class="n">route</span><span class="p">,</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">routes</span><span class="p">.</span><span class="nf">find</span> <span class="k">do</span> <span class="o">|</span><span class="n">route</span><span class="p">,</span> <span class="n">handler</span><span class="o">|</span>
      <span class="n">route</span> <span class="o">===</span> <span class="n">current_route</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="n">route</span>
      <span class="n">call_action_for</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"File not found"</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">add_route</span><span class="p">(</span><span class="nb">method</span><span class="p">:,</span> <span class="n">path</span><span class="p">:,</span> <span class="n">handler</span><span class="p">:)</span>
    <span class="n">routes</span><span class="p">[</span><span class="no">Route</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">method</span><span class="ss">:method</span><span class="p">,</span> <span class="n">path</span><span class="ss">:path</span><span class="p">)]</span> <span class="o">=</span> <span class="n">handler</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="k">def</span> <span class="nf">call_action_for</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="n">controller</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"#"</span><span class="p">)</span>
    <span class="n">controller_class</span> <span class="o">=</span> <span class="no">Kernel</span><span class="p">.</span><span class="nf">const_get</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
    <span class="n">controller_class</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">public_send</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>This works! We call the right action based on a dynamic segment! We can&rsquo;t stop yet. We&rsquo;re so close. We need to modify the controllers to expect request information so it knows WHICH programmer to show, AND we need to modify the request so it contains the value of the dynamic segment.</p>

<p>Let&rsquo;s do the easy stuff first.
Your home controller should look like this:</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">HomeController</span>
  <span class="nb">attr_reader</span> <span class="ss">:request</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="vi">@request</span> <span class="o">=</span> <span class="n">request</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">template</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'app/views/home/index.html.erb'</span><span class="p">)</span>
    <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre></td></tr></tbody></table></code></pre></div>
<p>And your ProgrammersController</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ProgrammersController</span>
  <span class="nb">attr_reader</span> <span class="ss">:request</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="vi">@request</span> <span class="o">=</span> <span class="n">request</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">programmers</span> <span class="o">=</span> <span class="no">Programmer</span><span class="p">.</span><span class="nf">all</span>
    <span class="n">template</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'app/views/programmers/index.html.erb'</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">).</span><span class="nf">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
    <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">programmer</span> <span class="o">=</span> <span class="no">Programmer</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s2">"id"</span><span class="p">])</span>
    <span class="n">template</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s2">"app/views/programmers/show.html.erb"</span><span class="p">)</span>
    <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">).</span><span class="nf">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Then make a template at <code>app/views/programmers/show.html.erb</code></p>
<div class="highlight"><pre class="highlight html"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>Potd<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;h1&gt;&lt;</span><span class="err">%=</span> <span class="na">programmer</span><span class="err">.</span><span class="na">name</span><span class="err">&lt;/</span><span class="na">h1</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h2&gt;&lt;</span><span class="err">%=</span> <span class="na">programmer</span><span class="err">.</span><span class="na">description</span> <span class="err">%</span><span class="nt">&gt;&lt;/h2&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></td></tr></tbody></table></code></pre></div>
<h3>Router updates</h3>

<p>In the router, update the request to include the dynamic segment info.</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c1">#...</span>
<span class="k">if</span> <span class="n">route</span>
  <span class="n">route</span><span class="p">.</span><span class="nf">update_params!</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
  <span class="n">call_action_for</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
<span class="k">else</span>
<span class="c1">#...</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Then in the route, add the method.</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">update_params!</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
  <span class="k">return</span> <span class="k">unless</span> <span class="n">has_dynamic_segment?</span>

  <span class="n">keys</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="nf">scan</span><span class="p">(</span><span class="sr">/:(\w+)/</span><span class="p">).</span><span class="nf">flatten</span>
  <span class="n">values</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">path</span><span class="p">.</span><span class="nf">scan</span><span class="p">(</span><span class="n">match_path</span><span class="p">).</span><span class="nf">flatten</span>
  <span class="n">dynamic_segment_params</span> <span class="o">=</span> <span class="n">keys</span><span class="p">.</span><span class="nf">zip</span><span class="p">(</span><span class="n">values</span><span class="p">).</span><span class="nf">to_h</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">params</span><span class="p">.</span><span class="nf">merge!</span><span class="p">(</span><span class="n">dynamic_segment_params</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Do nothing if there&rsquo;s nothing dynamic. Otherwise extract the keys, and values, zip them them merge it into the request&rsquo;s params hash.</p>

<h3>One more thing</h3>

<p>Add the Rack::Static Middleware. Any files in /public/css will be served without checking our routes. Great for stylesheets!</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nb">require_relative</span> <span class="s1">'config/environment'</span>
<span class="nb">require_relative</span> <span class="s1">'config/routes'</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">ContentType</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Static</span><span class="p">,</span> <span class="ss">urls: </span><span class="p">[</span><span class="s1">'/css'</span><span class="p">],</span> <span class="ss">root: </span><span class="s1">'public'</span>
<span class="n">run</span> <span class="no">Routes</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Run this in your terminal. I&rsquo;m assuming you have <code>wget</code> like a respectable developer.</p>
<div class="highlight"><pre class="highlight plaintext"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>mkdir -p public/css
cd public/css
wget https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css
</pre></td></tr></tbody></table></code></pre></div>
<p>Then add this line to the head of all of your html pages</p>
<div class="highlight"><pre class="highlight html"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"/css/bootstrap.min.css"</span><span class="nt">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div>
<h1>That&rsquo;s all!</h1>

<p>Next time, we&rsquo;ll handle posting from forms. I hope you found this useful, and enjoyed the journey.</p>

    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'hostiledeveloper'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  </main>

 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48123503-1', 'auto');
  ga('send', 'pageview');

</script>

 <em>Copyright &copy; 2021 Steven Nu&ntilde;ez - HostileDeveloper</em>

</div>
</body>
</html>
