<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1'/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hostile Developer - Guard this with your life... Or authenticating APIs with Guardian</title>
  <link href="/favicon.ico" rel="icon" type="image/ico" />
  <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
</head>
<body>
<div id="container">
  <section id="header">
  <header>
<a href="/">        <h1 class="brand"><span class="hostile">Hostile</span> Developer</h1>
        <h4 class="tag-line">I am Steven. Hear me Rant.</h4>
</a>  </header>

  <section class='social'>
    <a href="http://twitter.com/_StevenNunez/" target="_blank"><i class="fa fa-twitter"></i></a>
    <a href="https://github.com/StevenNunez/" target="_blank"><i class="fa fa-github"></i></a>
  </section>
</section>


  <main id='article' role="main">
    <h1 class="article-title"><a href="/2016/05/23/guard-this-with-your-life-or-authenticating-apis-with-guardian.html">Guard this with your life... Or authenticating APIs with Guardian</a></h1>
    <h1>Authentication in Phoenix</h1>

<p>Conceptually, authentication isn&rsquo;t hard. You collect a username and password, check it against your database and if it matches, WIN!</p>

<p><img alt="getinsertpic.com" src="http://media2.giphy.com/media/3BlN2bxcw0l5S/200.gif" /></p>

<p>&hellip; then you get into the business of persisting that information across requests, not to mention all of the security concerns of storing a password safely. In this post we&rsquo;ll be covering how to authenticate users, provide them with a token, and use that token on subsequent requests to identify our user. There are a TON of moving parts, so strap in.</p>

<h2>Overview</h2>

<p>We&rsquo;ll be covering:</p>

<ul>
<li>Modeling an Account</li>
<li>Using changesets</li>
<li>Hashing passwords with <a href="https://github.com/elixircnx/comeonin"><code>comeonin</code></a></li>
<li>Managing &ldquo;impure&rdquo; transactions in Service Modules</li>
<li>Using Guardian to manage token sharing</li>
<li>Identifying the logged in user</li>
</ul>

<h2>The App</h2>

<p>We&rsquo;ll be expanding on our Article Tracker located <a href="https://github.com/StevenNunez/article_tracker_hd/tree/authentication-blog-start">here</a>.</p>

<h2>Accounts</h2>

<p>Accounts will have an email and a password_digest. The digest will hold our hashed password&hellip; eventually.</p>

<p>Run <code>mix phoenix.gen.model Account accounts email password_digest</code> then <code>mix ecto.migrate</code>.</p>

<p>Open the new model, and update the schema to have a virtual attribute:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">schema</span> <span class="sd">"</span><span class="s2">accounts"</span> <span class="k">do</span>
  <span class="n">field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="n">field</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="n">field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">virtual:</span> <span class="no">true</span> <span class="c1"># &lt;- New line</span>

  <span class="n">timestamps</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Virtual attributes are a great way of taking a value from an interaction, but not persisting. In our case, we&rsquo;ll be using it to hold the value a users gives us before we hash and persist it.</p>

<h1>Changesets</h1>

<p>Changesets are a way of describing the process a set of proposed changes go through in preparation to being persisted. You define your rules, then try to persist. If everything is good to go, say passing all of your validation rules, it can be inserted into your database.</p>

<p>Storing passwords in plain text is a bad, NAY <em>TERRIBLE</em> IDEA!! We want to allow a user to send us a password, that we&rsquo;ll hash then store.</p>

<p>Creating a changeset is easy. In the model, we call <code>cast</code> and pass in the model, a map with proposed values, and the fields we require, and permit.</p>

<p>This is the built in one from our project. Be sure to change the <code>password_digest</code> in our <code>@required_fields</code> to <code>password</code>. The user will never pass us a <code>password_digest</code></p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nv">@required_fields</span> <span class="sx">~w(email password)</span> <span class="c1"># &lt;- Changed from password_digest to password</span>
<span class="nv">@optional_fields</span> <span class="sx">~w()</span>

<span class="k">def</span> <span class="n">changeset</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">params</span> <span class="p">\\</span> <span class="ss">:empty</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">model</span>
  <span class="o">|&gt;</span> <span class="n">cast</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nv">@required_fields</span><span class="p">,</span> <span class="nv">@optional_fields</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>This returns a changeset back. We can tag along another function, as long as it returns a changeset as well. Let&rsquo;s do some work to obfuscate the user&rsquo;s password.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="n">changeset</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">params</span> <span class="p">\\</span> <span class="ss">:empty</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">model</span>
  <span class="o">|&gt;</span> <span class="n">cast</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nv">@required_fields</span><span class="p">,</span> <span class="nv">@optional_fields</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="n">put_pass_hash</span>
<span class="k">end</span>

<span class="k">defp</span> <span class="n">put_pass_hash</span><span class="p">(</span><span class="n">changeset</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">password</span> <span class="o">=</span> <span class="n">changeset</span><span class="o">.</span><span class="n">changes</span><span class="o">.</span><span class="n">password</span>
  <span class="n">put_change</span><span class="p">(</span><span class="n">changeset</span><span class="p">,</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="no">String</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">password</span><span class="p">))</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Open up <code>iex -S mix</code> and try this out:</p>
<div class="highlight"><pre class="highlight plaintext"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>iex&gt; alias ArticleTrackerHd.Account
iex&gt; changeset = Account.changeset(%Account{}, %{email: "steven@example.com", password: "beef101"})
iex&gt; changeset.changes.password_digest # =&gt; "101feeb"
</pre></td></tr></tbody></table></code></pre></div>
<p>#security #hashtag. I think we need to be a bit more deliberate in our approach.</p>

<h1>Come on in!</h1>

<p>Maybe not what you want to hear in a security library, but, hey&hellip; We&rsquo;ll be adding this library to handle our password hashing.</p>

<p>Checkout their <a href="https://github.com/elixircnx/comeonin">github</a> and add the latest version to your <code>mix.exs</code> file.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[{</span><span class="ss">:phoenix</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.1.4"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:postgrex</span><span class="p">,</span> <span class="sd">"</span><span class="s2">&gt;= 0.0.0"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:phoenix_ecto</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.0"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:phoenix_html</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.4"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:phoenix_live_reload</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">,</span> <span class="ss">only:</span> <span class="ss">:dev</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:gettext</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 0.9"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:comeonin</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.4"</span><span class="p">},</span> <span class="c1"># &lt;- New line</span>
   <span class="p">{</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">}]</span>
<span class="k">end</span>


</pre></td></tr></tbody></table></code></pre></div>
<p>Then start the application:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="n">application</span> <span class="k">do</span>
  <span class="p">[</span><span class="ss">mod:</span> <span class="p">{</span><span class="no">ArticleTrackerHd</span><span class="p">,</span> <span class="p">[]},</span>
   <span class="ss">applications:</span> <span class="p">[</span>
     <span class="ss">:phoenix</span><span class="p">,</span>
     <span class="ss">:phoenix_html</span><span class="p">,</span>
     <span class="ss">:cowboy</span><span class="p">,</span>
     <span class="ss">:logger</span><span class="p">,</span>
     <span class="ss">:gettext</span><span class="p">,</span>
     <span class="ss">:phoenix_ecto</span><span class="p">,</span>
     <span class="ss">:postgrex</span><span class="p">,</span>
     <span class="ss">:comeonin</span> <span class="c1"># &lt;- New Line</span>
    <span class="p">]</span>
  <span class="p">]</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p><code>mix deps.get</code> and we&rsquo;re good to go.</p>

<h3>Updating our changeset</h3>

<p>Let&rsquo;s update to our super secure hashing algorithm.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">defp</span> <span class="n">put_pass_hash</span><span class="p">(</span><span class="n">changeset</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">password</span> <span class="o">=</span> <span class="n">changeset</span><span class="o">.</span><span class="n">changes</span><span class="o">.</span><span class="n">password</span>
  <span class="n">put_change</span><span class="p">(</span><span class="n">changeset</span><span class="p">,</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="no">Comeonin</span><span class="o">.</span><span class="no">Bcrypt</span><span class="o">.</span><span class="n">hashpwsalt</span><span class="p">(</span><span class="n">password</span><span class="p">))</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Open up <code>iex -S mix</code> and try again:</p>
<div class="highlight"><pre class="highlight plaintext"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>iex&gt; alias ArticleTrackerHd.{Account, Repo}
iex&gt; changeset = Account.changeset(%Account{}, %{email: "steven@example.com", password: "beef101"})
iex&gt; changeset.changes.password_digest # =&gt; "Something crazy"
iex&gt; Repo.insert!(changeset)
</pre></td></tr></tbody></table></code></pre></div>
<p>WIN! We&rsquo;re doing right by our users. Note that we saved user with an email of <code>steven@example.com</code> and a password of <code>beef101</code>.</p>

<h3>Authenticating users</h3>

<p>If you&rsquo;re coming from rails, you might be tempted to slap on an <code>authenticate</code> function and have it find the account, check the password and all that jazz. Well HOLD YOUR HORSES!
<img alt="getinsertpic.com" src="https://media3.giphy.com/media/ZvRz1cnhjyecw/200.gif" /></p>

<p>In Phoenix, we create &ldquo;pure&rdquo; function in our models and views, and &ldquo;impure&rdquo; functions&hellip; elsewhere. What is a &ldquo;pure&rdquo; function? Think of a function that takes in 2 values</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>If you call this function with 1 and 2, the result will always be the same. Now imagine calling this code:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="no">Repo</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="no">Account</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>This code might return 1 User, or 300. We&rsquo;re touching the outside world. Fancy terms for simple things.</p>

<p>Back to authentication. We need a place to handle our impure operations. I&rsquo;m coining a new term, We need a <em>Service Module</em></p>

<p><img alt="getinsertpic.com" src="http://media0.giphy.com/media/GsYaDdbX7k3Kw/200.gif" /></p>

<p>This module will hold our impure auth related stuff. Make a new file in <code>web/services</code> called <code>auth.ex</code>.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">Auth</span> <span class="k">do</span>
  <span class="n">alias</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="p">{</span><span class="no">Repo</span><span class="p">,</span> <span class="no">Account</span><span class="p">}</span>
  <span class="kn">import</span> <span class="no">Comeonin</span><span class="o">.</span><span class="no">Bcrypt</span><span class="p">,</span> <span class="ss">only:</span> <span class="p">[</span><span class="ss">checkpw:</span> <span class="m">2</span><span class="p">,</span> <span class="ss">dummy_checkpw:</span> <span class="m">0</span><span class="p">]</span>

  <span class="k">def</span> <span class="n">verify</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">account</span> <span class="o">=</span>  <span class="no">Repo</span><span class="o">.</span><span class="n">one</span><span class="p">(</span><span class="no">Account</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">))</span> <span class="c1"># &lt;- Need to define find_by_email</span>
    <span class="k">cond</span> <span class="k">do</span>
      <span class="n">account</span> <span class="o">&amp;&amp;</span> <span class="n">checkpw</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">account</span><span class="o">.</span><span class="n">password_digest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># &lt;- Valid account and password!</span>
        <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">account</span><span class="p">}</span>
      <span class="n">account</span> <span class="o">-&gt;</span> <span class="c1"># &lt;- Found account but password didn't match</span>
        <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:bad_password</span><span class="p">}</span>
      <span class="no">true</span> <span class="o">-&gt;</span>
        <span class="n">dummy_checkpw</span> <span class="c1"># &lt;- Fool hackers</span>
        <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:not_found</span><span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>So IMPURE! We have one nugget of purity and that&rsquo;s in the <code>find_by_email</code> function. That will return the query we&rsquo;ll pass to <code>Repo.one</code>. Here it is:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">from</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">__MODULE__</span><span class="p">,</span>
  <span class="ss">where:</span> <span class="n">a</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="o">^</span><span class="n">email</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Try it out. <code>iex -S mix</code>.</p>
<div class="highlight"><pre class="highlight plaintext"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>iex&gt; alias ArticleTrackerHd.{Account, Auth}
iex&gt; Auth.verify("steven@example.com", "beef101")
{:ok,
 %ArticleTrackerHd.Account{__meta__: #Ecto.Schema.Metadata&lt;:loaded&gt;,
  email: "steven@example.com", id: 1,
  inserted_at: #Ecto.DateTime&lt;2016-05-24T02:29:27Z&gt;, password: nil,
  password_digest: "$2b$12$vEJ80G.uEpJapbXgsGHBN.aZSgDD3yyWiQm.gimOSZimApDL.pTOm",
  updated_at: #Ecto.DateTime&lt;2016-05-24T02:29:27Z&gt;}}
iex&gt; Auth.verify("steven@example.com", "wrongpw")
{:error, :bad_password}
iex&gt; Auth.verify("nope@example.com", "wrongpw")  
{:error, :not_found}
</pre></td></tr></tbody></table></code></pre></div>
<p>GLORIOUS!!</p>

<h1>Guardian</h1>

<p>Guardian is a way of generating <a href="https://jwt.io">JWT</a> <a href="https://tools.ietf.org/html/rfc7519">tokens</a>. Tokens can be read from the session, or from the headers. We&rsquo;re designing this to work with an API, so we&rsquo;ll check the headers.</p>

<p>Guardian doesn&rsquo;t manage finding accounts, that&rsquo;s your job, hence all the blah blah from before. Once that&rsquo;s all set up, we&rsquo; can leverage Guardian to manage keeping our user requests and our app in sync.</p>

<p>Let&rsquo;s set it up. You&rsquo;ll need a key for the next part. Run <code>mix phoenix.gen.secret</code> and hold on to the value.</p>

<p>Open up <code>mix.exs</code>:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[{</span><span class="ss">:phoenix</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.1.4"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:postgrex</span><span class="p">,</span> <span class="sd">"</span><span class="s2">&gt;= 0.0.0"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:phoenix_ecto</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.0"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:phoenix_html</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.4"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:phoenix_live_reload</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">,</span> <span class="ss">only:</span> <span class="ss">:dev</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:gettext</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 0.9"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:comeonin</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.4"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:guardian</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 0.10.0"</span><span class="p">},</span> <span class="c1"># &lt;- New line</span>
   <span class="p">{</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">}]</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Run <code>mix deps.get</code> to get setup.</p>

<p>We&rsquo;ll need to create a configuration for Guardian in our <code>config.exs</code>.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">config</span> <span class="ss">:guardian</span><span class="p">,</span> <span class="no">Guardian</span><span class="p">,</span>
  <span class="ss">issuer:</span> <span class="sd">"</span><span class="s2">ArticleTrackerHd"</span><span class="p">,</span>
  <span class="ss">ttl:</span> <span class="p">{</span> <span class="m">30</span><span class="p">,</span> <span class="ss">:days</span> <span class="p">},</span>
  <span class="ss">secret_key:</span> <span class="sd">"</span><span class="s2">46l5yfRFGorxAArf64nGzHlfvSDAOUEV7m6c3/lf4LzZcBfUClDsSfNETrosmsdO"</span><span class="p">,</span> <span class="c1"># &lt;- Your Key</span>
  <span class="ss">serializer:</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">GuardianSerializer</span> <span class="c1"># &lt;- We'll create this next</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>OK, so a bunch of stuff is about to happen&hellip; Brace yourself.</p>

<p><img alt="getinsertpic.com" src="http://media3.giphy.com/media/psK7tSNSAE8Te/200.gif" /></p>

<p>We&rsquo;re going to add 2 plugs. One to teach Guardian how to find our token, and another that lets us convert the token to an account.</p>

<p>Open up your router and add:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">pipeline</span> <span class="ss">:api</span> <span class="k">do</span>
  <span class="n">plug</span> <span class="ss">:accepts</span><span class="p">,</span> <span class="p">[</span><span class="sd">"</span><span class="s2">json"</span><span class="p">]</span>
  <span class="n">plug</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">VerifyHeader</span><span class="p">,</span> <span class="ss">realm:</span> <span class="sd">"</span><span class="s2">Bearer"</span> <span class="c1"># &lt;- New line (1)</span>
  <span class="n">plug</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">LoadResource</span>                  <span class="c1"># &lt;- New line (2)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>The first line tells Guardian to look in the header for <code>Authorization: Bearer some_crazy_token</code>. If you didn&rsquo;t provide a realm, it would expect <code>Authorization: some_crazy_token</code>.</p>

<p>The second line works in tandem with the <em>not yet written</em> <code>ArticleTrackerHd.GuardianSerializer</code> to convert a token value into a record.</p>

<p>Let&rsquo;s go write that serializer. Create a file in <code>web/serializers</code> named <code>guardian_serializer.ex</code></p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">GuardianSerializer</span> <span class="k">do</span>
  <span class="nv">@behaviour</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Serializer</span>

  <span class="n">alias</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">Repo</span>
  <span class="n">alias</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">Account</span>

  <span class="k">def</span> <span class="n">for_token</span><span class="p">(</span><span class="n">account</span> <span class="o">=</span> <span class="p">%</span><span class="no">Account</span><span class="p">{}),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:ok</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Account:</span><span class="si">#{</span><span class="n">account</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
  <span class="k">def</span> <span class="n">for_token</span><span class="p">(</span><span class="n">_</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:error</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Unknown resource type"</span> <span class="p">}</span>

  <span class="k">def</span> <span class="n">from_token</span><span class="p">(</span><span class="sd">"</span><span class="s2">Account:"</span> <span class="o">&lt;&gt;</span> <span class="n">id</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:ok</span><span class="p">,</span> <span class="no">Repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="no">Account</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">def</span> <span class="n">from_token</span><span class="p">(</span><span class="n">_</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:error</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Unknown resource type"</span> <span class="p">}</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Nothing too crazy here. If you find a claim in the token like <code>Account:1</code>, find account with an id of 1.</p>

<p>That&rsquo;s it for Guardian Setup!</p>

<h2>Logging in</h2>

<p><img alt="getinsertpic.com" src="http://media2.giphy.com/media/xTiTngXiWGXLmIZVYY/200.gif" /></p>

<p>Let&rsquo;s tie this all together. We&rsquo;ll create a <code>SessionController</code> with a <code>create</code> action. It will check if the username and password are valid and if it is, we&rsquo;ll sign them in.</p>

<p>Modify your router:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">scope</span> <span class="sd">"</span><span class="s2">/api"</span><span class="p">,</span> <span class="no">ArticleTrackerHd</span> <span class="k">do</span>
  <span class="n">pipe_through</span> <span class="ss">:api</span>
  <span class="n">resources</span> <span class="sd">"</span><span class="s2">/articles"</span><span class="p">,</span> <span class="no">ArticleController</span><span class="p">,</span> <span class="ss">except:</span> <span class="p">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">]</span>
  <span class="n">post</span> <span class="sd">"</span><span class="s2">/log-in"</span><span class="p">,</span> <span class="no">SessionController</span><span class="p">,</span> <span class="ss">:create</span> <span class="c1"># &lt;- New line</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Then make a file in <code>web/controllers/</code> named <code>session_controller.ex</code>.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">SessionController</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>
  <span class="n">alias</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">Auth</span>

  <span class="k">def</span> <span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">%{</span><span class="sd">"</span><span class="s2">account"</span> <span class="o">=&gt;</span> <span class="p">%{</span><span class="sd">"</span><span class="s2">email"</span> <span class="o">=&gt;</span> <span class="n">email</span><span class="p">,</span> <span class="sd">"</span><span class="s2">password"</span> <span class="o">=&gt;</span> <span class="n">password</span><span class="p">}})</span> <span class="k">do</span>
    <span class="k">case</span> <span class="no">Auth</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="k">do</span> <span class="c1"># &lt;- 1</span>
      <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">account</span><span class="p">}</span> <span class="o">-&gt;</span>
         <span class="n">conn</span>
         <span class="o">|&gt;</span> <span class="n">sign_in</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
         <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">login.json"</span><span class="p">)</span>
      <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="n">conn</span>
        <span class="o">|&gt;</span> <span class="n">put_status</span><span class="p">(</span><span class="ss">:unprocessable_entity</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">sign_in</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">account</span><span class="p">)</span> <span class="k">do</span> <span class="c1"># &lt;- 2</span>
     <span class="n">conn</span>
     <span class="o">|&gt;</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">api_sign_in</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
     <span class="o">|&gt;</span> <span class="n">add_jwt</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">add_jwt</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="k">do</span> <span class="c1"># &lt;- 3</span>
    <span class="n">jwt</span> <span class="o">=</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">current_token</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">assign</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="ss">:jwt</span><span class="p">,</span> <span class="n">jwt</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre></td></tr></tbody></table></code></pre></div>
<p>Create a file named <code>session_view.ex</code> in <code>web/views/</code>:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">SessionView</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:view</span>

  <span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">login.json"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">jwt:</span> <span class="n">jwt</span><span class="p">})</span> <span class="k">do</span>
    <span class="p">%{</span> <span class="ss">jwt:</span> <span class="n">jwt</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>The important parts are are numbered.</p>

<ol>
<li>We&rsquo;re using our Auth Module!</li>
<li>We&rsquo;re using the Guardian.Plug.api_sign_in function. This will call our GuardianSerializer and add the account to the token.</li>
<li>This adds the generated jwt to the <code>conn</code> so we can use it in our <code>login.json</code>.</li>
</ol>

<p>Let&rsquo;s test it out!</p>
<div class="highlight"><pre class="highlight shell"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>curl <span class="nt">--data</span> <span class="s2">"account[email]=steven@example.com&amp;account[password]=beef101"</span> http://localhost:4000/api/log-in
<span class="c"># {"jwt":"eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJBY2NvdW50OjEiLCJleHAiOjE0NjY2NTQxMzUsImlhdCI6MTQ2NDA2MjEzNSwiaXNzIjoiQXJ0aWNsZVRyYWNrZXJIZCIsImp0aSI6IjhlOTE2ZjQ2LWM5MmEtNDBhMi1iYzE0LTY3Y2VjMmEyYzI1OSIsInBlbSI6e30sInN1YiI6IkFjY291bnQ6MSIsInR5cCI6InRva2VuIn0.OXK_Hu6uJRo3QClBdY05_xFuUdXK2NS3oTCRNZFd6yhyyl-ub1bjBZQV-flM3J6i7WIh1QUvTV4L7I6x72VADA"}</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>WOOOOOOOOT! Now we just need to make a request with that token, and we should be good to go.</p>

<h2>User Autorization</h2>

<p>So we&rsquo;re logged in. Now we want to restrict creating new articles to logged in users, but we want all users to be able to see them.</p>

<p>Open up the <code>ArticleTrackerHd.ArticleController</code>.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">ArticleController</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>

  <span class="n">alias</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">Article</span>

  <span class="n">plug</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">EnsureAuthenticated</span><span class="p">,</span> <span class="p">[</span><span class="ss">handler:</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">GuardianErrorHandler</span><span class="p">]</span>  <span class="ow">when</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:delete</span><span class="p">]</span> <span class="c1"># &lt;- New line</span>
  <span class="n">plug</span> <span class="ss">:scrub_params</span><span class="p">,</span> <span class="sd">"</span><span class="s2">article"</span> <span class="ow">when</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
<span class="c1">#...</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>This line makes it so only authenticated users can create articles. We&rsquo;ll have to create a new controller for handling guardian errors. If it fails authentication, it will call the <code>unauthenticated</code> function in the module you give it.</p>

<p>Put this in <code>web/controllers/guardian_error_handler</code>:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>
<span class="k">defmodule</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">GuardianErrorHandler</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>
  <span class="n">alias</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">GuardianErrorView</span>
  <span class="k">def</span> <span class="n">unauthenticated</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">conn</span>
      <span class="o">|&gt;</span> <span class="n">put_status</span><span class="p">(</span><span class="ss">:forbidden</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="no">GuardianErrorView</span><span class="p">,</span> <span class="ss">:forbidden</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>If it fails we want to render a view that returns a JSON message of forbidden. Make a new file in <code>web/views</code> named <code>guardian_error_view.ex</code>:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">GuardianErrorView</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:view</span>
  <span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">forbidden.json"</span><span class="p">,</span> <span class="n">_assigns</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">%{</span><span class="ss">message:</span> <span class="sd">"</span><span class="s2">Forbidden"</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Let&rsquo;s try this out, then get a beer.</p>
<div class="highlight"><pre class="highlight shell"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>curl <span class="nt">--data</span> <span class="s2">"account[email]=steven@example.com&amp;account[password]=beef101"</span> http://localhost:4000/api/log-in
<span class="c"># {"jwt":"eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJBY2NvdW50OjEiLCJleHAiOjE0NjY2NTQ2NzUsImlhdCI6MTQ2NDA2MjY3NSwiaXNzIjoiQXJ0aWNsZVRyYWNrZXJIZCIsImp0aSI6IjBjZDNiYWZhLTY4MjYtNGJlNi1hYWM3LTMzZWJkNTAwMzM5NyIsInBlbSI6e30sInN1YiI6IkFjY291bnQ6MSIsInR5cCI6InRva2VuIn0.S3jQkmtia-mlAv0O0u1QZxWr3MFH5IBnG1C_u0Uyjq6-DOA5is3l8tKiI0M83Vfw5ADUi55uXfoRqYRY7EQ-DQ"}</span>
curl http://localhost:4000/api/articles
<span class="c"># all the articles</span>
curl <span class="nt">--data</span> <span class="s2">"article[url]=http://example.com&amp;article[title]=A+Great+one&amp;article[categories]=foo.bar.baz"</span> http://localhost:4000/api/articles
<span class="c"># Forbidden</span>
curl <span class="nt">--data</span> <span class="s2">"article[url]=http://example.com&amp;article[title]=A+Great+one&amp;article[categories]=foo.bar.baz"</span> http://localhost:4000/api/articles <span class="nt">--header</span> <span class="s2">"Authorization: Bearer eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJBY2NvdW50OjEiLCJleHAiOjE0NjY2NTQ2NzUsImlhdCI6MTQ2NDA2MjY3NSwiaXNzIjoiQXJ0aWNsZVRyYWNrZXJIZCIsImp0aSI6IjBjZDNiYWZhLTY4MjYtNGJlNi1hYWM3LTMzZWJkNTAwMzM5NyIsInBlbSI6e30sInN1YiI6IkFjY291bnQ6MSIsInR5cCI6InRva2VuIn0.S3jQkmtia-mlAv0O0u1QZxWr3MFH5IBnG1C_u0Uyjq6-DOA5is3l8tKiI0M83Vfw5ADUi55uXfoRqYRY7EQ-DQ"</span>
curl http://localhost:4000/api/articles
</pre></td></tr></tbody></table></code></pre></div>
<p>VICTORY!</p>

<h2>Quick associations</h2>

<p>Let&rsquo;s add a reference to users on articles. Then we&rsquo;ll create them and attribute them.</p>

<p>Run <code>mix ecto.gen.migration add_account_reference_to_article</code></p>

<p>Then modify it to say:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">Repo</span><span class="o">.</span><span class="no">Migrations</span><span class="o">.</span><span class="no">AddAccountReferenceToArticle</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Ecto</span><span class="o">.</span><span class="no">Migration</span>

  <span class="k">def</span> <span class="n">change</span> <span class="k">do</span>
    <span class="n">alter</span> <span class="n">table</span><span class="p">(</span><span class="ss">:articles</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">add</span> <span class="ss">:account_id</span><span class="p">,</span> <span class="n">references</span><span class="p">(</span><span class="ss">:accounts</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Wire up the models:
In <code>article.ex</code>:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>
  <span class="n">schema</span> <span class="sd">"</span><span class="s2">articles"</span> <span class="k">do</span>
    <span class="n">field</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">field</span> <span class="ss">:url</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">field</span> <span class="ss">:categories</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">belongs_to</span> <span class="ss">:account</span><span class="p">,</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">Account</span> <span class="c1"># &lt;- New line</span>

    <span class="n">timestamps</span>
  <span class="k">end</span>

</pre></td></tr></tbody></table></code></pre></div>
<p>And in <code>account.ex</code>:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="n">schema</span> <span class="sd">"</span><span class="s2">accounts"</span> <span class="k">do</span>
  <span class="n">field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="n">field</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="n">field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">virtual:</span> <span class="no">true</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="no">ArticleTrackerHd</span><span class="o">.</span><span class="no">Article</span> <span class="c1"># &lt;- New Line</span>

  <span class="n">timestamps</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Then in our ArticleController, we need to find the user and create an associated:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">%{</span><span class="sd">"</span><span class="s2">article"</span> <span class="o">=&gt;</span> <span class="n">article_params</span><span class="p">})</span> <span class="k">do</span>
  <span class="n">account</span> <span class="o">=</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">current_resource</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="c1"># &lt;- New line</span>
  <span class="n">article</span> <span class="o">=</span> <span class="no">Ecto</span><span class="o">.</span><span class="n">build_assoc</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="ss">:articles</span><span class="p">)</span> <span class="c1"># &lt;- New line</span>
  <span class="n">changeset</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">changeset</span><span class="p">(</span><span class="n">article</span><span class="p">,</span> <span class="n">article_params</span><span class="p">)</span> <span class="c1"># &lt;- New line</span>
  <span class="c1"># ...</span>

<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Try it one more time</p>
<div class="highlight"><pre class="highlight shell"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>curl <span class="nt">--data</span> <span class="s2">"article[url]=http://example.com&amp;article[title]=A+Great+one&amp;article[categories]=foo.bar.baz"</span> http://localhost:4000/api/articles <span class="nt">--header</span> <span class="s2">"Authorization: Bearer eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJBY2NvdW50OjEiLCJleHAiOjE0NjY2NTQ2NzUsImlhdCI6MTQ2NDA2MjY3NSwiaXNzIjoiQXJ0aWNsZVRyYWNrZXJIZCIsImp0aSI6IjBjZDNiYWZhLTY4MjYtNGJlNi1hYWM3LTMzZWJkNTAwMzM5NyIsInBlbSI6e30sInN1YiI6IkFjY291bnQ6MSIsInR5cCI6InRva2VuIn0.S3jQkmtia-mlAv0O0u1QZxWr3MFH5IBnG1C_u0Uyjq6-DOA5is3l8tKiI0M83Vfw5ADUi55uXfoRqYRY7EQ-DQ"</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>And now it&rsquo;s all associated.</p>

<p><img alt="getinsertpic.com" src="http://media0.giphy.com/media/3puXxCB93ysGA/200.gif" /></p>

<h1>Conclusion</h1>

<p>And that&rsquo;s it! If you&rsquo;re thinking, &ldquo;MAN THAT WAS NUTS!&rdquo;, I agree. A lot of the documentation is hard to find. I&rsquo;m hoping to see more posts from YOU dear reader. Together we can make working with Phoenix and Elixir awesome.</p>

<p>I hope you find this useful when building Phoenix APIs! If you want to checkout the finished code, <a href="https://github.com/StevenNunez/article_tracker_hd/tree/authentication-blog-finish">checkout the repo</a>.</p>

<p>Found this interesting? Be sure to share it!</p>

<p><a href="https://twitter.com/share" class="twitter-share-button" data-text="User Auth with JWT and Phoenix" data-via="_StevenNunez" data-size="large">Tweet</a></p>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'hostiledeveloper'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  </main>

 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48123503-1', 'auto');
  ga('send', 'pageview');

</script>

 <em>Copyright &copy; 2019 Steven Nu&ntilde;ez - HostileDeveloper</em>

</div>
</body>
</html>
