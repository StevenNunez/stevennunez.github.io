<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1'/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hostile Developer - Connection Pools and RabbitMQ</title>
  <link href="/favicon.ico" rel="icon" type="image/ico" />
  <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    document.addEventListener("DOMContentLoaded", function(event) {
      mermaid.initialize({startOnLoad:true});
    });
  </script>
<div id="container">
  <section id="header">
  <header>
<a href="/">        <h1 class="brand"><span class="hostile">Hostile</span> Developer</h1>
        <h4 class="tag-line">I am Steven. Hear me Rant.</h4>
</a>  </header>

  <section class='social'>
    <a href="http://twitter.com/_StevenNunez/" target="_blank"><i class="fa fa-twitter"></i></a>
    <a href="https://github.com/StevenNunez/" target="_blank"><i class="fa fa-github"></i></a>
  </section>
</section>


  <main id='article' role="main">
    <h1 class="article-title"><a href="/2020/08/09/connection-pools-and-rabbitmq.html">Connection Pools and RabbitMQ</a></h1>
    <p>In this post, we&rsquo;re going to go over connection pools how to use ex_rabbit_pool to manage connections and channels.
These concepts will be covered further in my <a href="https://2020.elixirconf.com/trainers/4/course">course at ElixirConf</a>.</p>

<h2>Connection Pools</h2>

<p>If you&rsquo;ve used Ecto, you&rsquo;ve used connection pools. Connection pools allow you to allocate a number of connections to a service and allow processes in your system to use those connections to do work concurrently. In the case of Ecto, when you make a query, one of the available connections is checked out, used to make the query and return results. When it&rsquo;s done, it goes back in the pool.</p>

<p>With RabbitMQ ideally you&rsquo;re going to have <a href="https://www.cloudamqp.com/blog/2018-01-19-part4-rabbitmq-13-common-errors.html">1 connection per resource</a>. One connection for publishing, and one connection for consuming. When we use connection pools with Rabbit, we&rsquo;re <em>really</em> going to be configuring a <strong>channel pool</strong>.</p>

<h2>Connections and Channels</h2>

<p>Think of a connection as a tunnel, and a channel as a bunch of runners that go through the tunnel.
<img alt="Download?force=true&amp;w=640" src="https://unsplash.com/photos/3fzYRVQu_3c/download?force=true&amp;w=640" /></p>

<p>Photo by Marcos Nieto on Unsplash</p>

<p>These slackers aren&rsquo;t very inspiring.</p>

<p>Channels allow you to multiplex over a single TCP connection. Since connections are pretty heavy (costing the server about 100KB), channels give us a way find the resource sweet spot. The <a href="https://www.rabbitmq.com/channels.html#resource-usage">Channels guide</a> notes that pooling should be used when managing your own channels becomes a pain but why not go for broke from the jump?</p>

<h2>Getting Started</h2>

<p>Let&rsquo;s start with a project:</p>

<script src="https://gist.github.com/octosteve/6d1a15f7a45572c9a39cbcf94e33cdae.js"></script>

<p>Open up <code>mix.exs</code> and add <a href="https://github.com/esl/ex_rabbit_pool">ex_rabbit_pool</a>, then run <code>mix deps.get</code></p>

<script src="https://gist.github.com/octosteve/82cb9836bc4a7d1648cf46e62509341f.js"></script>

<p>Great! Let&rsquo;s start out with the easier of the 2. The publishing pool. Again, we&rsquo;re going for a SINGLE connection but multiple channels. Since publishers don&rsquo;t block, we can keep the count pretty low. Let&rsquo;s start out with 2 channels.</p>

<script src="https://gist.github.com/octosteve/fcf9706108409911248a133ebd6a9320.js"></script>

<p>A whole-lotta code. Let&rsquo;s jump right in:</p>

<ol>
<li>If you&rsquo;ve worked with <a href="https://github.com/devinus/poolboy">Poolboy</a> before, this syntax should look familiar.
We&rsquo;re configuring 1 <code>ExRabbitPool.Worker.RabbitConnection</code> process to be checkout-able. These configs go straight to Poolboy.</li>
<li>These rabbit configs get passed in to the worker when it&rsquo;s checked out.</li>
<li>You&rsquo;ve been using these sweet <code>child_spec/1</code> functions since Elixir 1.5! They let you define what it means to <em>start</em> your server.
Here, we&rsquo;re doing a little&hellip; but with a lot of code. <code>id</code> is what your Supervisor will use to track your process. <code>start</code>, well, that&rsquo;s how you start the dang thing. Notice we&rsquo;re just delegating to <code>ExRabbitPool.PoolSupervisor.start_link/2</code>. That second argument to the Pool Supervisor&rsquo;s <code>start_link</code> is the name you can use to reference this process.</li>
</ol>

<p>Add this to <code>application.ex</code>
<script src="https://gist.github.com/octosteve/8318539fd3d5e82cd1a7ca97b1f41436.js"></script>
Run <code>iex -S mix</code> and you&rsquo;ll see this in observer.</p>

<p><a href="https://imgur.com/cnWlTDU"><img width="100%" src="https://i.imgur.com/cnWlTDU.png" title="source: imgur.com" /></a></p>

<p>Open the Rabbit Console and you&rsquo;ll see 1 connection and 2 channels. Just what we want!</p>

<p><a href="https://imgur.com/tPwPhop"><img src="https://i.imgur.com/tPwPhop.png" title="source: imgur.com" /></a></p>

<p>Let&rsquo;s create a publisher that publishes to a <code>what_should_we_do</code> exchange with a payload of &ldquo;Pool Time!&rdquo;
<script src="https://gist.github.com/octosteve/f19d7a058ae5350feb0e936383f8f584.js"></script></p>

<p>The <code>ExRabbitPool.RabbitMQ</code> module <a href="https://github.com/esl/ex_rabbit_pool/blob/master/lib/clients/rabbitmq.ex">delegates all of it&rsquo;s calls</a> to the underlying
<a href="https://github.com/pma/amqp">amqp</a> library, but we&rsquo;ll use this to support any
changes they may make in the future. Don&rsquo;t worry about declaring the exchange multiple
times. The only time this will cause a problem is if you call it with different configurations
on subsequent calls.</p>

<p>In <code>iex</code> run <code>Pooler.PoolTimePublisher.publish</code>, then open the rabbit console to see
your new exchange!</p>

<p><a href="https://imgur.com/iczQAPS"><img src="https://i.imgur.com/iczQAPS.png" title="source: imgur.com" /></a></p>

<h2>Consumers</h2>

<p>Peanut butter has Jelly, Publishers have consumers. We&rsquo;re going to take a different approach for consumers, instead using a provided macro that hides all of the
fetching and returning stuff the <code>ExRabbitPool.with_channel/2</code> function was doing for you.</p>

<p>First, we need a new pool.</p>

<h3>Consumer Pool</h3>

<p>Very similar to the Publisher Pool, except we&rsquo;re going to bump the channels to 5. This is something we&rsquo;d tweak over time, with a good signal being that your consumers occasionally crash because they can&rsquo;t get a channel. This could be due to consumers taking a long time to finish a request, or having more concurrent work than you have channels. In any event, this is something you&rsquo;ll have to tweak for your environment.</p>

<script src="https://gist.github.com/octosteve/ce73de390dc416f17e22ba2bf258a7ae.js"></script>

<p>Same as before except with a higher channel count. Be sure to update <code>application.ex</code></p>

<script src="https://gist.github.com/octosteve/a999e4089dc034d27786adc104ba19b5.js"></script>

<p>On to our Consumer.
The best APIs offer nice abstractions but let you reach into the internals when needed. We&rsquo;ll see how in a bit.
We&rsquo;re going to create a queue that consumes messages from
our exchange. We&rsquo;re going to use a named durable queue to allow us to stop consumers
and not lose messages.</p>

<script src="https://gist.github.com/octosteve/816d77c74b0850c985fd76a8ae5de357.js"></script>

<p>A lot going is on here but let&rsquo;s take a look.</p>

<ol>
<li>We&rsquo;re defining our <code>child_spec/1</code> that passes in the consumer pool we defined and a queue.</li>
<li><code>setup_channel/2</code> is one of the defined hooks that let us setup any additional connections and bindings prior to consuming messages on the queue. As previously mentioned, don&rsquo;t worry about redeclaring the exchange, or the queue for that matter. You&rsquo;ll only get an issue if you try to change its properties.</li>
<li>This is where the money is ðŸ’°ðŸ’°ðŸ’°. <code>basic_deliver/3</code> gets called when a message makes its way to our queue. We&rsquo;re on the hook for returning <code>:ok</code> or <code>{:stop, reason}</code> to kill the server.</li>
</ol>

<p>The other callbacks defined are <code>basic_consume_ok/2</code>, triggered when a consumer successfully joins, and
kbasic<em>cancel/3<code></code>basic</em>cancel_ok/2` for handling cancellation events.</p>

<p>Don&rsquo;t forget to update <code>application.ex</code></p>

<script src="https://gist.github.com/octosteve/7a29ab01e5986873c732168518713368.js"></script>

<h2>Test Drive</h2>

<p>Let&rsquo;s see how you work with this thing. Let&rsquo;s publish a message that says &ldquo;Pool Time!&rdquo; on to the <code>what_should_we_do</code> exchange.</p>

<p>Start firing off those messages with <code>Pooler.PoolTimePublisher.publish/0</code>.</p>

<p><a href="https://imgur.com/OhIVclm"><img src="https://i.imgur.com/OhIVclm.png" title="source: imgur.com" /></a></p>

<p>SUCH POWER!!</p>

<h2>Why bother</h2>

<p>This might seem like a big lift, but there&rsquo;s one big benefit to not having to manage your own channel
handshakes. Failure. If you were managing channels and connections on your own, you&rsquo;d have to write a slew of other processes to
free up resources when you failed. Or you&rsquo;d have to set up separate monitors to clean up after your GenServers. With
<code>ExRabbitPool</code> you keep things in a clean, expected state. Let&rsquo;s update our consumer to raise an exception like an
underslept teenager. We&rsquo;re going to change the restart strategy to <code>:temporary</code> to not bring down the world,.</p>

<script src="https://gist.github.com/octosteve/fa6109cd145231b5b980fac2e8da89db.js"></script>

<p>Go ahead and publish some messages. Sure it crashes, but look at your stats.</p>

<p>Rabbit is holding on to your message until you get can get your act together.</p>

<p><a href="https://imgur.com/EnLDYSG"><img src="https://i.imgur.com/EnLDYSG.png" title="source: imgur.com" /></a></p>

<p>&hellip; and your channels are ready to field new requests.</p>

<p><a href="https://imgur.com/xIjvVdl"><img src="https://i.imgur.com/xIjvVdl.png" title="source: imgur.com" /></a></p>

<p>That&rsquo;s all for today. Thanks for reading.</p>

    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'hostiledeveloper'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  </main>

 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48123503-1', 'auto');
  ga('send', 'pageview');

</script>

 <em>Copyright &copy; 2021 Steven Nu&ntilde;ez - HostileDeveloper</em>

</div>
</body>
</html>
