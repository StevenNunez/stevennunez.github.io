<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1'/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hostile Developer - Salesforce Outbound messages and Phoenix</title>
  <link href="/favicon.ico" rel="icon" type="image/ico" />
  <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    document.addEventListener("DOMContentLoaded", function(event) {
      mermaid.initialize({startOnLoad:true});
    });
  </script>
<div id="container">
  <section id="header">
  <header>
<a href="/">        <h1 class="brand"><span class="hostile">Hostile</span> Developer</h1>
        <h4 class="tag-line">I am Steven. Hear me Rant.</h4>
</a>  </header>

  <section class='social'>
    <a href="http://twitter.com/_StevenNunez/" target="_blank"><i class="fa fa-twitter"></i></a>
    <a href="https://github.com/StevenNunez/" target="_blank"><i class="fa fa-github"></i></a>
  </section>
</section>


  <main id='article' role="main">
    <h1 class="article-title"><a href="/2020/05/09/salesforce-outbound-messages-and-phoenix.html">Salesforce Outbound messages and Phoenix</a></h1>
    <h1>Let&rsquo;s sell some stuff!</h1>

<p><a href="https://www.salesforce.com/">Salesforce</a> is an incredibly popular and powerful sales tracking system. With over 150k customers
and an extensible platform, it&rsquo;s a great opportunity to use our favorite programming language to get in on the action.</p>

<p>There are several libraries to access the SalesForce API like Jeff Weiss&rsquo; <a href="https://github.com/jeffweiss/forcex">forcex</a>,
but not too much written about handling Outbound Messages.</p>

<h2>Outbound Messages</h2>

<p>Outbound Messages are webhooks that are triggered when a Salesforce object is updated. There are 
<a href="https://medium.com/@MicroPyramid/how-to-set-up-outbound-messaging-in-salesforce-42a0a08e65b1">tutorials</a> 
on how to <a href="https://www.salesforcetutorial.com/generating-outbound-message-workflow-action/">setup</a>
the Salesforce side of this, so I won&rsquo;t be covering it. Assume there&rsquo;s an Outbound Messages set to trigger whenever
the <em>Stage</em> of an <em>Opportunity</em> has been updated.</p>

<h3>Getting the message</h3>

<p>The first thing we need to do is build a way to accept the Outbound message from Salesforce. This may make some of you
cringe but we&rsquo;re going to have to accept&hellip; XML. Particularly, a SOAP response. If you don&rsquo;t know what SOAP is, don&rsquo;t 
worry about it. We&rsquo;re going to treat this like regular XML.</p>

<h3>Plug Parsers</h3>

<p>Crack open your <code>endpoint.ex</code> file and you should see something like this:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>  <span class="n">plug</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Parsers</span><span class="p">,</span>
    <span class="ss">parsers:</span> <span class="p">[</span><span class="ss">:urlencoded</span><span class="p">,</span> <span class="ss">:multipart</span><span class="p">,</span> <span class="ss">:json</span><span class="p">],</span>
    <span class="ss">pass:</span> <span class="p">[</span><span class="s2">"*/*"</span><span class="p">],</span>
    <span class="ss">json_decoder:</span> <span class="no">Phoenix</span><span class="o">.</span><span class="n">json_library</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Under the covers, Plug comes with a few modules to handle json, multipart and url encoded requests.
You can take a look at the code for <code>urlencoded</code>&lsquo;s parser
<a href="https://github.com/elixir-plug/plug/blob/65986ad32f9aaae3be50dc80cbdd19b326578da7/lib/plug/parsers/urlencoded.ex">here</a>.
Every parser needs 2 functions. an <code>init/1</code> function for compiled configuration, and a <code>parse/5</code> function.
The <a href="https://hexdocs.pm/plug/Plug.Parsers.html#c:parse/5"><code>parse/5</code></a> function returns a tuple with <code>{:ok, params, conn}</code>
if it <em>can</em> parse this kind of request, or <code>{:next, conn}</code> if it can&rsquo;t.</p>

<p>One parser that&rsquo;s missing is an XML parser! No worries. We can handle all of our processing of the Outbound Message in the
parser leaving our controller to code to deal with our nice, cleanly parsed data.</p>

<p>Let&rsquo;s make a new Parser.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">SFDCWebhookParser</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">opts</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="n">opts</span>
  <span class="k">def</span> <span class="n">parse</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">,</span> <span class="s2">"xml"</span><span class="p">,</span> <span class="n">_headers</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">conn</span><span class="p">}</span> <span class="o">=</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span><span class="o">.</span><span class="n">read_body</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">extract_from_webhook</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">%{</span><span class="ss">notifications:</span> <span class="n">notifications</span><span class="p">},</span> <span class="n">conn</span><span class="p">}</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="n">parse</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_type</span><span class="p">,</span> <span class="n">_subtype</span><span class="p">,</span> <span class="n">_headers</span><span class="p">,</span> <span class="n">_opts</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:next</span><span class="p">,</span> <span class="n">conn</span><span class="p">}</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Here we have a parser that responds to messages with a content type of &ldquo;text/xml&rdquo; since we&rsquo;re getting a SOAP message. 
We call <code>Plug.Conn.read_body/2</code> in order to load request body. Then we pass it into our (as yet to be written) <code>extract_from_webhook/1</code> function.
In order to work on that&hellip; we&rsquo;ll need to dive into parsing XML with <a href="https://hexdocs.pm/sweet_xml/SweetXml.html">SweetXml</a>.</p>

<h3>SweetXml</h3>

<p>For this next bit, we&rsquo;re going to need to talk about <a href="https://www.w3schools.com/xml/xpath_intro.asp">XPath</a>. XPath is a way of 
traversing nodes in a tree. Take this HTML for instance:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="n">html</span> <span class="o">=</span> <span class="sd">"""
&lt;div&gt;
  &lt;ul edible="no"&gt;
    &lt;li&gt;One fish&lt;/li&gt;
    &lt;li&gt;Two Fish&lt;/li&gt;
    &lt;li&gt;Red Fish&lt;/li&gt;
    &lt;li&gt;Blue Fish&lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;
"""</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Now we can use <code>SweetXml</code> to extract out some data from this markup and put in in a map for us.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="no">SweetXml</span>
<span class="n">html</span>
<span class="o">|&gt;</span> <span class="n">xpath</span><span class="p">(</span>
<span class="sx">~x"//ul"</span><span class="p">,</span> <span class="c1"># From the root, find a ul node</span>
 <span class="ss">edible:</span> <span class="sx">~x"@edible"</span><span class="p">,</span> <span class="c1"># From that node, read its `edible` attribute</span>
 <span class="ss">items:</span> <span class="sx">~x"./li/text()"</span><span class="n">l</span> <span class="c1"># Also from that node, find any li nodes and return their text. The `l` informs it we want a list back.</span>
<span class="p">)</span>
<span class="p">%{</span><span class="ss">edible:</span> <span class="s1">'no'</span><span class="p">,</span> <span class="ss">items:</span> <span class="p">[</span><span class="s1">'One fish'</span><span class="p">,</span> <span class="s1">'Two Fish'</span><span class="p">,</span> <span class="s1">'Red Fish'</span><span class="p">,</span> <span class="s1">'Blue Fish'</span><span class="p">]}</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>With this, we have enough to get data out of our Webhook.</p>

<h3>Notification Message</h3>

<p>The <a href="https://developer.salesforce.com/docs/atlas.en-us.api.meta/api/sforce_api_om_outboundmessaging_wsdl.htm">docs</a> give
an outline of the anatomy of a message. Here&rsquo;s a sample message from the sandbox environment:</p>
<div class="highlight"><pre class="highlight xml"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;soapenv:Envelope</span> <span class="na">xmlns:soapenv=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
 <span class="nt">&lt;soapenv:Body&gt;</span>
  <span class="nt">&lt;notifications</span> <span class="na">xmlns=</span><span class="s">"http://soap.sforce.com/2005/09/outbound"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;OrganizationId&gt;</span>00D5w000004qGTOEA2<span class="nt">&lt;/OrganizationId&gt;</span>
   <span class="nt">&lt;ActionId&gt;</span>04k5w000000TSwMAAW<span class="nt">&lt;/ActionId&gt;</span>
   <span class="nt">&lt;SessionId&gt;</span>...<span class="nt">&lt;/SessionId&gt;</span>
   <span class="nt">&lt;EnterpriseUrl&gt;</span>...<span class="nt">&lt;/EnterpriseUrl&gt;</span>
   <span class="nt">&lt;PartnerUrl&gt;</span>...<span class="nt">&lt;/PartnerUrl&gt;</span>
   <span class="nt">&lt;Notification&gt;</span>
    <span class="nt">&lt;Id&gt;</span>04l5w00005286hAAAQ<span class="nt">&lt;/Id&gt;</span>
    <span class="nt">&lt;sObject</span> <span class="na">xsi:type=</span><span class="s">"sf:Opportunity"</span> <span class="na">xmlns:sf=</span><span class="s">"urn:sobject.enterprise.soap.sforce.com"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;sf:Id&gt;</span>0065w000023STAmAAO<span class="nt">&lt;/sf:Id&gt;</span>
     <span class="nt">&lt;sf:AccountId&gt;</span>0015w00002BFDeLAAX<span class="nt">&lt;/sf:AccountId&gt;</span>
     <span class="nt">&lt;sf:Amount&gt;</span>45000.0<span class="nt">&lt;/sf:Amount&gt;</span>
     <span class="nt">&lt;sf:CloseDate&gt;</span>2020-07-11<span class="nt">&lt;/sf:CloseDate&gt;</span>
     <span class="nt">&lt;sf:ContactId&gt;</span>0035w000035gg9GAAQ<span class="nt">&lt;/sf:ContactId&gt;</span>
     <span class="nt">&lt;sf:CreatedById&gt;</span>0055w00000BhqR0AAJ<span class="nt">&lt;/sf:CreatedById&gt;</span>
     <span class="nt">&lt;sf:CreatedDate&gt;</span>2020-05-08T13:40:22.000Z<span class="nt">&lt;/sf:CreatedDate&gt;</span>
     <span class="nt">&lt;sf:FiscalQuarter&gt;</span>3<span class="nt">&lt;/sf:FiscalQuarter&gt;</span>
     <span class="nt">&lt;sf:FiscalYear&gt;</span>2020<span class="nt">&lt;/sf:FiscalYear&gt;</span>
     <span class="nt">&lt;sf:Follow_Up__c&gt;</span>false<span class="nt">&lt;/sf:Follow_Up__c&gt;</span>
     <span class="nt">&lt;sf:HasOpenActivity&gt;</span>false<span class="nt">&lt;/sf:HasOpenActivity&gt;</span>
     <span class="nt">&lt;sf:HasOpportunityLineItem&gt;</span>false<span class="nt">&lt;/sf:HasOpportunityLineItem&gt;</span>
     <span class="nt">&lt;sf:HasOverdueTask&gt;</span>false<span class="nt">&lt;/sf:HasOverdueTask&gt;</span>
     <span class="nt">&lt;sf:IsClosed&gt;</span>false<span class="nt">&lt;/sf:IsClosed&gt;</span>
     <span class="nt">&lt;sf:IsDeleted&gt;</span>false<span class="nt">&lt;/sf:IsDeleted&gt;</span>
     <span class="nt">&lt;sf:IsWon&gt;</span>false<span class="nt">&lt;/sf:IsWon&gt;</span>
     <span class="nt">&lt;sf:LastModifiedById&gt;</span>0055w00000BhqR0AAJ<span class="nt">&lt;/sf:LastModifiedById&gt;</span>
     <span class="nt">&lt;sf:LastModifiedDate&gt;</span>2020-05-09T03:04:32.000Z<span class="nt">&lt;/sf:LastModifiedDate&gt;</span>
     <span class="nt">&lt;sf:LastReferencedDate&gt;</span>2020-05-09T03:06:37.000Z<span class="nt">&lt;/sf:LastReferencedDate&gt;</span>
     <span class="nt">&lt;sf:LastViewedDate&gt;</span>2020-05-09T03:06:37.000Z<span class="nt">&lt;/sf:LastViewedDate&gt;</span>
     <span class="nt">&lt;sf:LeadSource&gt;</span>External Referral<span class="nt">&lt;/sf:LeadSource&gt;</span>
     <span class="nt">&lt;sf:Name&gt;</span>Backpackers, Inc. (Sample)<span class="nt">&lt;/sf:Name&gt;</span>
     <span class="nt">&lt;sf:OwnerId&gt;</span>0055w00000BhqR0AAJ<span class="nt">&lt;/sf:OwnerId&gt;</span>
     <span class="nt">&lt;sf:Probability&gt;</span>80.0<span class="nt">&lt;/sf:Probability&gt;</span>
     <span class="nt">&lt;sf:StageName&gt;</span>Negotiation/Review<span class="nt">&lt;/sf:StageName&gt;</span>
     <span class="nt">&lt;sf:SystemModstamp&gt;</span>2020-05-09T03:04:32.000Z<span class="nt">&lt;/sf:SystemModstamp&gt;</span>
    <span class="nt">&lt;/sObject&gt;</span>
   <span class="nt">&lt;/Notification&gt;</span>
  <span class="nt">&lt;/notifications&gt;</span>
 <span class="nt">&lt;/soapenv:Body&gt;</span> 
<span class="nt">&lt;/soapenv:Envelope&gt;</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>It&rsquo;s pretty beefy, but parsing will be pretty straight forward. The documentation states we may get up to 100 notification 
nodes.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="no">SweetXml</span>
<span class="k">def</span> <span class="n">extract_from_webhook</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">body</span> <span class="o">|&gt;</span> <span class="n">xpath</span><span class="p">(</span><span class="sx">~x"//Notification"</span><span class="n">l</span><span class="p">,</span> <span class="c1"># Support for multiple notifications</span>
  <span class="ss">message_id:</span> <span class="sx">~x"./Id/text()"</span><span class="p">,</span>
  <span class="ss">type:</span> <span class="sx">~x"./sObject/@xsi:type"</span><span class="p">,</span>
  <span class="ss">object_id:</span> <span class="sx">~x"./sObject/sf:Id/text()"</span><span class="p">,</span>
  <span class="ss">account_id:</span> <span class="sx">~x"./sObject/sf:AccountId/text()"</span><span class="p">,</span>
  <span class="ss">amount:</span> <span class="sx">~x"./sObject/sf:Amount/text()"</span><span class="p">,</span>
  <span class="ss">close_date:</span> <span class="sx">~x"./sObject/sf:CloseDate/text()"</span><span class="p">,</span>
  <span class="ss">contact_id:</span> <span class="sx">~x"./sObject/sf:ContactId/text()"</span><span class="p">,</span>
  <span class="ss">created_by_id:</span> <span class="sx">~x"./sObject/sf:CreatedById/text()"</span><span class="p">,</span>
  <span class="ss">created_date:</span> <span class="sx">~x"./sObject/sf:CreatedDate/text()"</span><span class="p">,</span>
  <span class="ss">fiscal_quarter:</span> <span class="sx">~x"./sObject/sf:FiscalQuarter/text()"</span><span class="p">,</span>
  <span class="ss">fiscal_year:</span> <span class="sx">~x"./sObject/sf:FiscalYear/text()"</span><span class="p">,</span>
  <span class="ss">follow_up:</span> <span class="sx">~x"./sObject/sf:Follow_Up__c/text()"</span><span class="p">,</span>
  <span class="ss">has_open_activity:</span> <span class="sx">~x"./sObject/sf:HasOpenActivity/text()"</span><span class="p">,</span>
  <span class="ss">has_opportunity_line_item:</span> <span class="sx">~x"./sObject/sf:HasOpportunityLineItem/text()"</span><span class="p">,</span>
  <span class="ss">has_overdue_task:</span> <span class="sx">~x"./sObject/sf:HasOverdueTask/text()"</span><span class="p">,</span>
  <span class="ss">is_closed:</span> <span class="sx">~x"./sObject/sf:IsClosed/text()"</span><span class="p">,</span>
  <span class="ss">is_deleted:</span> <span class="sx">~x"./sObject/sf:IsDeleted/text()"</span><span class="p">,</span>
  <span class="ss">is_won:</span> <span class="sx">~x"./sObject/sf:IsWon/text()"</span><span class="p">,</span>
  <span class="ss">last_modified:</span> <span class="sx">~x"./sObject/sf:LastModifiedById/text()"</span><span class="p">,</span>
  <span class="ss">last_modified_date:</span> <span class="sx">~x"./sObject/sf:LastModifiedDate/text()"</span><span class="p">,</span>
  <span class="ss">last_reference_date:</span> <span class="sx">~x"./sObject/sf:LastReferencedDate/text()"</span><span class="p">,</span>
  <span class="ss">last_viewed_date:</span> <span class="sx">~x"./sObject/sf:LastViewedDate/text()"</span><span class="p">,</span>
  <span class="ss">lead_source:</span> <span class="sx">~x"./sObject/sf:LeadSource/text()"</span><span class="p">,</span>
  <span class="ss">name:</span> <span class="sx">~x"./sObject/sf:Name/text()"</span><span class="p">,</span>
  <span class="ss">owner_id:</span> <span class="sx">~x"./sObject/sf:OwnerId/text()"</span><span class="p">,</span>
  <span class="ss">probability:</span> <span class="sx">~x"./sObject/sf:Probability/text()"</span><span class="p">,</span>
  <span class="ss">stage_name:</span> <span class="sx">~x"./sObject/sf:StageName/text()"</span><span class="p">,</span>
  <span class="ss">system_modstamp:</span> <span class="sx">~x"./sObject/sf:SystemModstamp/text()"</span>
<span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>This will return the following as params:</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="p">[</span>
  <span class="p">%{</span>
    <span class="ss">account_id:</span> <span class="s1">'0015w00002BFDeLAAX'</span><span class="p">,</span>
    <span class="ss">amount:</span> <span class="s1">'45000.0'</span><span class="p">,</span>
    <span class="ss">close_date:</span> <span class="s1">'2020-07-11'</span><span class="p">,</span>
    <span class="ss">contact_id:</span> <span class="s1">'0035w000035gg9GAAQ'</span><span class="p">,</span>
    <span class="ss">created_by_id:</span> <span class="s1">'0055w00000BhqR0AAJ'</span><span class="p">,</span>
    <span class="ss">created_date:</span> <span class="s1">'2020-05-08T13:40:22.000Z'</span><span class="p">,</span>
    <span class="ss">fiscal_quarter:</span> <span class="s1">'3'</span><span class="p">,</span>
    <span class="ss">fiscal_year:</span> <span class="s1">'2020'</span><span class="p">,</span>
    <span class="ss">follow_up:</span> <span class="s1">'false'</span><span class="p">,</span>
    <span class="ss">has_open_activity:</span> <span class="s1">'false'</span><span class="p">,</span>
    <span class="ss">has_opportunity_line_item:</span> <span class="s1">'false'</span><span class="p">,</span>
    <span class="ss">has_overdue_task:</span> <span class="s1">'false'</span><span class="p">,</span>
    <span class="ss">is_closed:</span> <span class="s1">'false'</span><span class="p">,</span>
    <span class="ss">is_deleted:</span> <span class="s1">'false'</span><span class="p">,</span>
    <span class="ss">is_won:</span> <span class="s1">'false'</span><span class="p">,</span>
    <span class="ss">last_modified:</span> <span class="s1">'0055w00000BhqR0AAJ'</span><span class="p">,</span>
    <span class="ss">last_modified_date:</span> <span class="s1">'2020-05-09T03:04:32.000Z'</span><span class="p">,</span>
    <span class="ss">last_reference_date:</span> <span class="s1">'2020-05-09T03:06:37.000Z'</span><span class="p">,</span>
    <span class="ss">last_viewed_date:</span> <span class="s1">'2020-05-09T03:06:37.000Z'</span><span class="p">,</span>
    <span class="ss">lead_source:</span> <span class="s1">'External Referral'</span><span class="p">,</span>
    <span class="ss">message_id:</span> <span class="s1">'04l5w00005286hAAAQ'</span><span class="p">,</span>
    <span class="ss">name:</span> <span class="s1">'Backpackers, Inc. (Sample)'</span><span class="p">,</span>
    <span class="ss">object_id:</span> <span class="s1">'0065w000023STAmAAO'</span><span class="p">,</span>
    <span class="ss">owner_id:</span> <span class="s1">'0055w00000BhqR0AAJ'</span><span class="p">,</span>
    <span class="ss">probability:</span> <span class="s1">'80.0'</span><span class="p">,</span>
    <span class="ss">stage_name:</span> <span class="s1">'Negotiation/Review'</span><span class="p">,</span>
    <span class="ss">system_modstamp:</span> <span class="s1">'2020-05-09T03:04:32.000Z'</span><span class="p">,</span>
    <span class="ss">type:</span> <span class="s1">'sf:Opportunity'</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>Woot! Now that map will be passed in <code>params</code> to your controller actions. There&rsquo;s one more thing we need to make Salesforce happy.</p>

<h3>The response.</h3>

<p>Say we&rsquo;re routing Outbound messages to <code>SalesforceWeb.WebhookController.webhook/2</code>. We&rsquo;ll need to respond with a SOAP
response to acknowledge the message.</p>
<div class="highlight"><pre class="highlight elixir"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">SalesforceWeb</span><span class="o">.</span><span class="no">WebhookController</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">SalesforceDotComWeb</span><span class="p">,</span> <span class="ss">:controller</span>

  <span class="k">def</span> <span class="n">webhook</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">params</span> <span class="o">|&gt;</span> <span class="n">do_cool_things</span><span class="p">()</span>
    <span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="n">put_resp_content_type</span><span class="p">(</span><span class="s2">"text/xml"</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">send_resp</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">acknowledgement</span><span class="p">())</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">acknowledgement</span> <span class="k">do</span>
    <span class="sd">"""
    &lt;?xml version="1.0" encoding="UTF-8"?&gt;
        &lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;
            &lt;soapenv:Body&gt;
                &lt;notificationsResponse xmlns="http://soap.sforce.com/2005/09/outbound"&gt;
                    &lt;Ack&gt;true&lt;/Ack&gt;
               &lt;/notificationsResponse&gt;
            &lt;/soapenv:Body&gt;
        &lt;/soapenv:Envelope&gt;
    """</span> <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>With this, we&rsquo;re all set! NOTE: The acknowledgement will always be the same.</p>

<h1>Next Steps</h1>

<p>It&rsquo;d be nice to have type conversion of strings to booleans and dates, but this is a great start. I hope this was informative.</p>

<p>Happy clacking!</p>

    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'hostiledeveloper'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  </main>

 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48123503-1', 'auto');
  ga('send', 'pageview');

</script>

 <em>Copyright &copy; 2021 Steven Nu&ntilde;ez - HostileDeveloper</em>

</div>
</body>
</html>
